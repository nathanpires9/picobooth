{% extends "base.html" %} {% block title %}Photo Booth{% endblock %} {% block
  content %}
  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Chewy&display=swap"
    rel="stylesheet"
  />
  <!-- QR Code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
  
  <div class="photo-booth-container">
    <div class="photo-booth">
      <div class="header-section">
        <h1><i class="fas fa-camera-retro"></i> PicoBooth</h1>
        <p class="subtitle">
          Capture your fun moments and create magical photo strips!
        </p>
  
        <!-- Photo Options -->
        <div class="photo-options">
          <label>Number of Photos:</label>
          <div class="custom-dropdown">
            <div class="selected-option">
              <span>3</span>
              <i class="fas fa-chevron-down"></i>
            </div>
            <ul class="dropdown-options">
              <li data-value="1">1 (Large Photo)</li>
              <li data-value="3" class="selected">3</li>
              <li data-value="4">4</li>
              <li data-value="5">5</li>
            </ul>
          </div>
        </div>
      </div>
  
      <div class="photo-session-container">
        <!-- Camera Feed -->
        <div class="control-panel">
          <div class="camera-container">
            <div class="camera-frame" id="camera-frame">
              <video id="video" autoplay playsinline></video>
              <canvas id="canvas" style="display: none"></canvas>
              <div id="countdown" class="countdown">
                <div class="countdown-circle">
                  <span id="countdown-text"></span>
                </div>
              </div>
              <div class="flash-overlay"></div>
              <div id="camera-error" class="camera-error" style="display: none">
                <i class="fas fa-camera-slash"></i>
                <p>Camera not available</p>
              </div>
            </div>
          </div>
        </div>
  
        <!-- Photo Preview Sidebar -->
        <div id="photo-preview-sidebar" class="photo-preview-sidebar">
          <h3><i class="fas fa-images"></i> Your Photos</h3>
          <div class="upload-controls">
            <input type="file" id="photo-upload" accept="image/*" multiple style="display: none">
            <button id="upload-btn" class="btn btn-primary">
              <i class="fas fa-upload"></i> Upload Photos
            </button>
            <span class="upload-hint">or drag & drop images here</span>
          </div>
          <div id="photo-preview-container" class="photo-preview-container">
            <div class="preview-placeholder">
              <i class="fas fa-camera"></i>
              <p>Your photos will appear here</p>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Strip Preview Area -->
      <div class="preview-section">
        <div id="strip-preview" class="strip-preview" style="display: none">
          <div class="strip-frame-container">
            <div class="strip-frame">
              <canvas id="strip-canvas"></canvas>
            </div>
          </div>
          <div
            id="qr-code-container"
            style="display: none; text-align: center; margin-top: 15px"
          >
            <div id="qr-code"></div>
            <p>Scan to download to your phone</p>
            <button
              id="download-qr-btn"
              class="btn btn-primary"
              style="margin-top: 8px"
            >
              <i class="fas fa-download"></i> Download QR Code
            </button>
          </div>
        </div>
  
        <div id="all-photos-captured" class="all-photos-captured">
          <span id="all-photos-text"></span>
        </div>
  
        <!-- Main Controls -->
        <div class="main-controls">
          <button
            id="capture-btn"
            class="btn btn-primary pulse-animation"
            disabled
          >
            <i class="fas fa-camera"></i> Capture Photo
          </button>
          <button
            id="clear-stickers-btn"
            class="btn btn-danger"
            style="display: none"
          >
            <i class="fas fa-trash-alt"></i> Clear Stickers
          </button>
          <button id="save-btn" class="btn btn-success" style="display: none">
            <i class="fas fa-download"></i> Save Strip
          </button>
          <button id="qr-btn" class="btn btn-info" style="display: none">
            <i class="fas fa-qrcode"></i> Get QR Code
          </button>
          <button
            id="retry-camera-btn"
            class="btn btn-warning"
            style="display: none"
          >
            <i class="fas fa-sync-alt"></i> Retry Camera
          </button>
        </div>
      </div>
  
      <!-- Filter Options -->
      <div id="filter-options" class="customization-options">
        <div class="option-panel filter-panel">
          <h3><i class="fas fa-sliders-h"></i> Apply Filters</h3>
          <div class="filters">
            <div class="filter-option" data-filter="normal">
              <div
                class="filter-preview"
                style="background: linear-gradient(135deg, #ff69b4, #ff8ac5)"
              ></div>
              <span>Vibrant</span>
            </div>
            <div class="filter-option" data-filter="grayscale">
              <div
                class="filter-preview"
                style="background: linear-gradient(135deg, #777, #999)"
              ></div>
              <span>Classic</span>
            </div>
            <div class="filter-option" data-filter="sepia">
              <div
                class="filter-preview"
                style="background: linear-gradient(135deg, #704214, #8b5a2b)"
              ></div>
              <span>Vintage</span>
            </div>
            <div class="filter-option" data-filter="invert">
              <div
                class="filter-preview"
                style="background: linear-gradient(135deg, #000, #222)"
              ></div>
              <span>Invert</span>
            </div>
          </div>
        </div>
      </div>
  
      <!-- Customization Options -->
      <div
        id="customization-options"
        class="customization-options"
        style="display: none"
      >
        <!-- Stickers Panel -->
        <div class="option-panel sticker-panel">
          <h3><i class="fas fa-sticky-note"></i> Add Stickers</h3>
          <div class="stickers">
            <img
              src="{{ url_for('static', filename='stickers/sticker1.png') }}"
              alt="Sticker 1"
              class="sticker"
              draggable="true"
            />
            <img
              src="{{ url_for('static', filename='stickers/sticker2.png') }}"
              alt="Sticker 2"
              class="sticker"
              draggable="true"
            />
            <img
              src="{{ url_for('static', filename='stickers/sticker3.png') }}"
              alt="Sticker 3"
              class="sticker"
              draggable="true"
            />
            <img
            src="{{ url_for('static', filename='stickers/sticker4.png') }}"
            alt="Sticker 4"
            class="sticker"
            draggable="true"
          />
          <img
          src="{{ url_for('static', filename='stickers/sticker5.png') }}"
          alt="Sticker 5"
          class="sticker"
          draggable="true"
        />
        <img
        src="{{ url_for('static', filename='stickers/sticker6.png') }}"
        alt="Sticker 6"
        class="sticker"
        draggable="true"
      />
      <img
      src="{{ url_for('static', filename='stickers/sticker7.png') }}"
      alt="Sticker 7"
      class="sticker"
      draggable="true"
    />
    <img
    src="{{ url_for('static', filename='stickers/sticker8.png') }}"
    alt="Sticker 8"
    class="sticker"
    draggable="true"
  />
  <img
  src="{{ url_for('static', filename='stickers/sticker9.png') }}"
  alt="Sticker 9"
  class="sticker"
  draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker10.png') }}"
alt="Sticker 10"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker11.png') }}"
alt="Sticker 11"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker12.png') }}"
alt="Sticker 12"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker13.png') }}"
alt="Sticker 13"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker14.png') }}"
alt="Sticker 14"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker15.png') }}"
alt="Sticker 15"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker16.png') }}"
alt="Sticker 16"
class="sticker"
draggable="true"
/>
<img
src="{{ url_for('static', filename='stickers/sticker17.png') }}"
alt="Sticker 17"
class="sticker"
draggable="true"
/>
          </div>
        </div>
  
        <!-- Color Options -->
        <div class="option-panel color-options">
          <h3><i class="fas fa-palette"></i> Strip Color</h3>
          <div class="color-pagination">
            <span class="page-indicator active" data-page="1"></span>
            <span class="page-indicator" data-page="2"></span>
            <span class="page-indicator" data-page="3"></span>
          </div>
          <div class="colors color-page active" data-page="1">
            <div
              class="color-option selected"
              data-color="#ff69b4"
              style="background-color: #ff69b4"
            ></div>
            <div
              class="color-option"
              data-color="#77dd77"
              style="background-color: #77dd77"
            ></div>
            <div
              class="color-option"
              data-color="#87ceeb"
              style="background-color: #87ceeb"
            ></div>
            <div
              class="color-option"
              data-color="#ffd700"
              style="background-color: #ffd700"
            ></div>
            <div
              class="color-option"
              data-color="#ffa500"
              style="background-color: #ffa500"
            ></div>
            <div
              class="color-option"
              data-color="#ff6b6b"
              style="background-color: #ff6b6b"
            ></div>
            <div
              class="color-option"
              data-color="#9d7a8f"
              style="background-color: #9d7a8f"
            ></div>
            <div
              class="color-option"
              data-color="#a0e7e5"
              style="background-color: #a0e7e5"
            ></div>
            <div
              class="color-option"
              data-color="#b5ead7"
              style="background-color: #b5ead7"
            ></div>
            <div
              class="color-option"
              data-color="#ff9ff3"
              style="background-color: #ff9ff3"
            ></div>
            <div
              class="color-option"
              data-color="#feca57"
              style="background-color: #feca57"
            ></div>
            <div
              class="color-option"
              data-color="#ffffff"
              style="background-color: #ffffff; border: 1px solid #ddd"
            ></div>
            <div
              class="color-option"
              data-color="#ff9a9e"
              style="background-color: #ff9a9e"
            ></div>
            <div
              class="color-option"
              data-color="#fad0c4"
              style="background-color: #fad0c4"
            ></div>
            <div
              class="color-option"
              data-color="#a18cd1"
              style="background-color: #a18cd1"
            ></div>
            <div
              class="color-option"
              data-color="#fbc2eb"
              style="background-color: #fbc2eb"
            ></div>
            <div
              class="color-option"
              data-color="#84fab0"
              style="background-color: #84fab0"
            ></div>
            <div
              class="color-option"
              data-color="#8fd3f4"
              style="background-color: #8fd3f4"
            ></div>
            <div
              class="color-option"
              data-color="#a6c1ee"
              style="background-color: #a6c1ee"
            ></div>
            <div
              class="color-option"
              data-color="#f093fb"
              style="background-color: #f093fb"
            ></div>
            <div
              class="color-option"
              data-color="#f5576c"
              style="background-color: #f5576c"
            ></div>
          </div>
          <div class="colors color-page" data-page="2">
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #77dd77, #94e694)"
              style="background: linear-gradient(135deg, #77dd77, #94e694)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #87ceeb, #a6e1fa)"
              style="background: linear-gradient(135deg, #87ceeb, #a6e1fa)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #ff69b4, #ff8ac5)"
              style="background: linear-gradient(135deg, #ff69b4, #ff8ac5)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #ffd700, #ffe55c)"
              style="background: linear-gradient(135deg, #ffd700, #ffe55c)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #9d7a8f, #c2a3b8)"
              style="background: linear-gradient(135deg, #9d7a8f, #c2a3b8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #ff6b6b, #ff9e9e)"
              style="background: linear-gradient(135deg, #ff6b6b, #ff9e9e)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #a0e7e5, #c5f5f3)"
              style="background: linear-gradient(135deg, #a0e7e5, #c5f5f3)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #b5ead7, #d5f4e8)"
              style="background: linear-gradient(135deg, #b5ead7, #d5f4e8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #ff9ff3, #ffc2f8)"
              style="background: linear-gradient(135deg, #ff9ff3, #ffc2f8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #feca57, #ffe194)"
              style="background: linear-gradient(135deg, #feca57, #ffe194)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #5f27cd, #8b5ce8)"
              style="background: linear-gradient(135deg, #5f27cd, #8b5ce8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #1dd1a1, #4ce8b8)"
              style="background: linear-gradient(135deg, #1dd1a1, #4ce8b8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #ff9a9e, #ffc3c6)"
              style="background: linear-gradient(135deg, #ff9a9e, #ffc3c6)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #a18cd1, #c5b3e8)"
              style="background: linear-gradient(135deg, #a18cd1, #c5b3e8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #84fab0, #a8fdc8)"
              style="background: linear-gradient(135deg, #84fab0, #a8fdc8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #a6c1ee, #c9d9f8)"
              style="background: linear-gradient(135deg, #a6c1ee, #c9d9f8)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #f5576c, #ff8a97)"
              style="background: linear-gradient(135deg, #f5576c, #ff8a97)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #4facfe, #7bc4ff)"
              style="background: linear-gradient(135deg, #4facfe, #7bc4ff)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #43e97b, #6ef09b)"
              style="background: linear-gradient(135deg, #43e97b, #6ef09b)"
            ></div>
            <div
              class="color-option"
              data-color="linear-gradient(135deg, #fa709a, #ffa5c3)"
              style="background: linear-gradient(135deg, #fa709a, #ffa5c3)"
            ></div>
          </div>
          <div class="colors color-page" data-page="3">
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='strips/cloud.png') }}')"
              style="background-image:url('{{ url_for('static', filename='strips/cloud.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='love-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='love-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='friendship-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='friendship-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='kids-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='kids-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='holiday-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='holiday-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='gradient-sparkle.png') }}')"
              style="background-image:url('{{ url_for('static', filename='gradient-sparkle.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='confetti-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='confetti-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='polka-dot-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='polka-dot-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='stripes-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='stripes-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='watercolor-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='watercolor-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='marble-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='marble-pattern.png') }}');background-size:cover;"
            ></div>
            <div
              class="color-option"
              data-color="url('{{ url_for('static', filename='glitter-pattern.png') }}')"
              style="background-image:url('{{ url_for('static', filename='glitter-pattern.png') }}');background-size:cover;"
            ></div>
          </div>
        </div>
  
        <!-- Preset Themes -->
        <div class="option-panel preset-options">
          <h3><i class="fas fa-magic"></i> Quick Themes</h3>
          <div class="presets">
            <div
              class="preset"
              data-color="#ff69b4"
              data-stickers="sticker1.png,sticker2.png"
            >
              <div class="preset-color" style="background-color: #ff69b4"></div>
              <span>Pink Party</span>
            </div>
            <div
              class="preset"
              data-color="#77dd77"
              data-stickers="sticker2.png,sticker3.png"
            >
              <div class="preset-color" style="background-color: #77dd77"></div>
              <span>Green Groove</span>
            </div>
            <div
              class="preset"
              data-color="#87ceeb"
              data-stickers="sticker1.png,sticker3.png"
            >
              <div class="preset-color" style="background-color: #87ceeb"></div>
              <span>Blue Bliss</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Popup Modal -->
      <div id="popup-overlay" class="popup-overlay">
        <div class="popup-panel">
          <p id="popup-message"></p>
          <div class="popup-buttons" id="popup-buttons">
            <button id="start-btn" class="btn btn-primary">
              <i class="fas fa-play"></i> Start
            </button>
            <button id="more-time-btn" class="btn btn-secondary">
              <i class="fas fa-clock"></i> More Time
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <style>
    /* ===== Base Styles ===== */
    :root {
      --pink: #ff6b9d;
      --pink-light: #ffc0d9;
      --pink-lighter: #ffe6ee;
      --purple: #9d7a8f;
      --purple-dark: #5e2e53;
      --green: #77dd77;
      --blue: #87ceeb;
      --yellow: #ffd700;
      --info: #17a2b8;
      --warning: #ffc107;
      --strip-display-width: 320px; /* Desktop display width */
      --strip-display-mobile: 280px; /* Mobile display width */
      --photo-width: 1200px; /* New rectangular photo dimensions */
      --photo-height: 800px;
    }
  
    body {
      font-family: "Montserrat", sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
      line-height: 1.6;
      touch-action: manipulation;
    }
  
    .photo-booth-container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      box-sizing: border-box;
    }
  
    .photo-booth {
      background-color: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      padding: 30px;
      position: relative;
    }
  
    /* ===== Header Section ===== */
    .header-section {
      text-align: center;
      margin-bottom: 30px;
      position: relative;
      z-index: 1;
    }
  
    h1 {
      color: var(--purple-dark);
      font-family: "Chewy", cursive;
      font-size: 2.8rem;
      margin-bottom: 5px;
      text-shadow: 2px 2px 0 rgba(255, 255, 255, 0.5);
      background: linear-gradient(135deg, var(--pink), var(--green), var(--blue));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
  
    .subtitle {
      text-align: center;
      color: var(--purple);
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 500;
    }
  
    /* ===== Photo Options ===== */
    .photo-options {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
      background: var(--pink-lighter);
      padding: 15px;
      border-radius: 50px;
      max-width: 400px;
      margin: 0 auto;
      box-shadow: 0 4px 15px rgba(255, 107, 157, 0.1);
      position: relative;
      z-index: 1001;
    }
  
    .photo-options label {
      font-weight: 600;
      color: var(--purple-dark);
      margin: 0;
    }
  
    /* ===== Modern Dropdown ===== */
    .custom-dropdown {
      position: relative;
      display: inline-block;
      width: 100px;
      z-index: 1002;
    }
  
    .selected-option {
      padding: 10px 15px;
      background-color: white;
      border: 2px solid var(--pink);
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--purple-dark);
    }
  
    .selected-option:hover {
      background-color: var(--pink-lighter);
      transform: translateY(-2px);
    }
  
    .selected-option i {
      font-size: 12px;
      transition: transform 0.3s;
    }
  
    .dropdown-options {
      position: absolute;
      width: 100%;
      background: white;
      border: 2px solid var(--pink);
      border-radius: 15px;
      margin-top: 10px;
      display: none;
      z-index: 1003;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      list-style: none;
      padding: 10px 0;
      animation: fadeIn 0.3s ease-out;
    }
  
    .dropdown-options li {
      padding: 10px 15px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      color: var(--purple-dark);
    }
  
    .dropdown-options li:hover {
      background-color: var(--pink-light);
      color: white;
    }
  
    .dropdown-options li.selected {
      background-color: var(--pink);
      color: white;
    }
  
    /* ===== Layout Structure ===== */
    .photo-session-container {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
    }
  
    .control-panel {
      flex: 2;
      background-color: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
  
    .photo-preview-sidebar {
      flex: 1;
      background-color: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      min-width: 250px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
  
    /* ===== Updated Preview Section ===== */
    .preview-section {
      background-color: #f8f9fa;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
  
    .main-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
  
    /* ===== Updated Strip Preview Styles ===== */
    .strip-preview {
      display: none;
      margin: 0 auto 10px;
      width: 100%;
      max-width: var(--strip-display-width);
    }
  
    .strip-frame-container {
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      margin: 0 auto;
      overflow: visible;
    }
  
    .strip-frame {
      background: white;
      border-radius: 5px;
      padding: 5px;
      border: 10px solid white;
      width: 100%;
      max-width: var(--strip-display-width);
      margin: 0 auto;
      position: relative;
      overflow: visible;
    }
  
    #strip-canvas {
      width: 100% !important;
      height: auto !important;
      max-width: 100%;
      display: block;
      border-radius: 5px;
    }
  
    /* ===== Camera Styles ===== */
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
    }
  
    .camera-frame {
      position: relative;
      border: 3px solid var(--pink);
      border-radius: 15px;
      overflow: hidden;
      background-color: #000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      aspect-ratio: 4/3;
    }
  
    #video {
      width: 100%;
      height: 100%;
      display: block;
      transform: scaleX(-1);
      transition: opacity 0.3s;
      background-color: #000;
      object-fit: cover;
    }
  
    /* Camera Error State */
    .camera-error {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 20;
    }
  
    .camera-error i {
      font-size: 50px;
      margin-bottom: 15px;
      color: var(--pink-light);
    }
  
    .camera-error p {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
  
    /* ===== Modern Countdown ===== */
    .countdown {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 10;
    }
  
    .countdown-circle {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background-color: rgba(255, 105, 180, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
      animation: pulse 1s infinite alternate;
    }
  
    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 30px rgba(255, 105, 180, 0.6);
      }
      100% {
        transform: scale(1.1);
        box-shadow: 0 0 50px rgba(255, 105, 180, 1);
      }
    }
  
    #countdown-text {
      font-size: 72px;
      color: white;
      font-family: "Chewy", cursive;
      text-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
  
    /* ===== Flash Effect ===== */
    .flash-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      opacity: 0;
      pointer-events: none;
      z-index: 5;
    }
  
    /* ===== Photo Previews ===== */
    .photo-preview-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 15px;
      min-height: 400px;
    }
  
    .preview-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #aaa;
      font-size: 1rem;
      padding: 20px;
      border: 2px dashed var(--pink);
      border-radius: 10px;
      background-color: rgba(255, 192, 217, 0.1);
    }
  
    .preview-placeholder i {
      font-size: 40px;
      margin-bottom: 10px;
      color: var(--pink-light);
    }
  
    .photo-preview-item {
      position: relative;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
  
    .photo-preview-item:hover {
      transform: translateY(-5px);
    }
  
    .photo-preview {
      width: 100%;
      border-radius: 10px;
      border: 3px solid var(--pink);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
  
    .photo-preview:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
  
    .photo-preview-number {
      position: absolute;
      top: -10px;
      left: -10px;
      background-color: var(--pink);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
      z-index: 1;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
    }
  
    /* ===== Upload Controls ===== */
    .upload-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
  
    .upload-hint {
      font-size: 0.9rem;
      color: var(--purple);
      font-style: italic;
    }
  
    /* ===== Buttons ===== */
    .btn {
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      -webkit-tap-highlight-color: transparent;
    }
  
    .btn-primary {
      background: linear-gradient(135deg, var(--pink), var(--pink-light));
      color: white;
    }
  
    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--pink-light), var(--pink));
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 105, 180, 0.3);
    }
  
    .btn-success {
      background: linear-gradient(135deg, var(--green), #94e694);
      color: white;
    }
  
    .btn-success:hover {
      background: linear-gradient(135deg, #94e694, var(--green));
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(119, 221, 119, 0.3);
    }
  
    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
    }
  
    .btn-danger:hover {
      background: linear-gradient(135deg, #ff8e8e, #ff6b6b);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
    }
  
    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #8a939b);
      color: white;
    }
  
    .btn-secondary:hover {
      background: linear-gradient(135deg, #8a939b, #6c757d);
      transform: translateY(-3px);
    }
  
    .btn-info {
      background: linear-gradient(135deg, var(--info), #5bc0de);
      color: white;
    }
  
    .btn-info:hover {
      background: linear-gradient(135deg, #5bc0de, var(--info));
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(23, 162, 184, 0.3);
    }
  
    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #ffd45c);
      color: white;
    }
  
    .btn-warning:hover {
      background: linear-gradient(135deg, #ffd45c, var(--warning));
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 193, 7, 0.3);
    }
  
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
  
    .pulse-animation {
      animation: pulse 1.5s infinite;
    }
  
    @keyframes pulse {
      0% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
  
    /* ===== Filter Options ===== */
    .filters {
      display: flex;
      gap: 15px;
      padding: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
  
    .filter-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
      padding: 15px;
      border-radius: 10px;
    }
  
    .filter-option:hover {
      background-color: rgba(255, 192, 217, 0.2);
      transform: translateY(-3px);
    }
  
    .filter-preview {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #ddd;
      transition: all 0.3s;
    }
  
    .filter-option.selected .filter-preview {
      border-color: var(--pink);
      transform: scale(1.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
  
    .filter-option.selected {
      background-color: var(--pink-lighter);
    }
  
    .filter-option span {
      font-weight: 600;
      color: var(--purple-dark);
    }
  
    /* ===== Customization Options ===== */
    .customization-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
  
    .option-panel {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }
  
    .option-panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
  
    .option-panel h3 {
      color: var(--purple-dark);
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  
    /* ===== Stickers ===== */
    .stickers {
      display: flex;
      gap: 15px;
      padding: 10px 0;
      flex-wrap: wrap;
    }
  
    .sticker {
      width: 60px;
      height: 60px;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 10px;
    }
  
    .sticker:hover {
      transform: scale(1.1) rotate(5deg);
      filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.2));
    }
  
    /* ===== Color Options ===== */
    .color-pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }
  
    .page-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #ddd;
      cursor: pointer;
      transition: all 0.3s;
    }
  
    .page-indicator.active {
      background-color: var(--pink);
      transform: scale(1.2);
    }
  
    .colors {
      display: flex;
      gap: 15px;
      padding: 10px 0;
      flex-wrap: wrap;
    }
  
    .color-page {
      display: none;
    }
  
    .color-page.active {
      display: flex;
    }
  
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.3s;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
  
    /* Fix for gradient color options */
    .color-option[style*="linear-gradient"] {
      border-radius: 10px;
      background-size: cover !important;
    }
  
    .color-option.selected {
      border-color: var(--purple-dark);
      transform: scale(1.2);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
  
    .color-option:hover:not(.selected) {
      transform: scale(1.1);
    }
  
    /* Pattern preview styles */
    .color-option[data-color^="url("] {
      background-size: cover;
      background-position: center;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
  
    .color-option[data-color^="url("]::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
  
    .color-option[data-color^="url("]:hover::after {
      background: rgba(0, 0, 0, 0);
    }
  
    .color-option[data-color^="url("].selected::after {
      background: rgba(0, 0, 0, 0);
      box-shadow: 0 0 0 3px var(--purple-dark);
    }
  
    /* ===== Preset Themes ===== */
    .presets {
      display: flex;
      gap: 15px;
      padding: 10px 0;
      flex-wrap: wrap;
    }
  
    .preset {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s;
      padding: 15px;
      border-radius: 10px;
    }
  
    .preset:hover {
      background-color: rgba(255, 192, 217, 0.2);
      transform: translateY(-3px);
    }
  
    .preset-color {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid #ddd;
      transition: all 0.3s;
    }
  
    .preset:hover .preset-color {
      transform: scale(1.1);
    }
  
    .preset span {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--purple-dark);
    }
  
    /* ===== Popup ===== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
      animation: fadeIn 0.3s;
    }
  
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  
    .popup-panel {
      background-color: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      transform: scale(0.9);
      animation: popIn 0.3s forwards;
    }
  
    @keyframes popIn {
      0% {
        transform: scale(0.9);
      }
      50% {
        transform: scale(1.05);
      }
      100% {
        transform: scale(1);
      }
    }
  
    .popup-panel p {
      font-size: 1.1rem;
      color: var(--purple-dark);
      margin-bottom: 25px;
      line-height: 1.6;
    }
  
    .popup-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
  
    /* ===== All Photos Captured ===== */
    .all-photos-captured {
      display: none;
      background-color: var(--green);
      color: white;
      padding: 15px;
      border-radius: 50px;
      margin: 15px auto;
      max-width: 300px;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(119, 221, 119, 0.3);
    }
  
    /* ===== QR Code Styles ===== */
    #qr-code-container {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
  
    #qr-code {
      margin: 0 auto;
      width: 150px;
      height: 150px;
      background: white;
      padding: 10px;
      border-radius: 8px;
    }
  
    #qr-code img {
      width: 100%;
      height: 100%;
    }
  
    /* ===== Sticker Containers ===== */
    .sticker-container {
      position: absolute;
      cursor: move;
      transition: transform 0.1s;
      z-index: 10;
    }
  
    .sticker-container:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 5px 10px rgba(0, 0, 0, 0.3));
    }
  
    .sticker-container img {
      width: 100%;
      height: 100%;
      pointer-events: none;
      user-select: none;
    }
  
    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: white;
      border: 2px solid var(--pink);
      border-radius: 50%;
      right: -6px;
      bottom: -6px;
      cursor: nwse-resize;
      z-index: 11;
      transition: all 0.2s;
    }
  
    .resize-handle:hover {
      transform: scale(1.3);
      background-color: var(--pink);
    }
  
    /* ===== Responsive Adjustments ===== */
    @media (max-width: 900px) {
      .photo-session-container {
        flex-direction: column;
      }
  
      .photo-preview-sidebar {
        order: -1;
      }
    }
  
    @media (max-width: 768px) {
      .main-controls {
        flex-direction: column;
        align-items: center;
      }
  
      .btn {
        width: 100%;
        max-width: 250px;
        justify-content: center;
      }
  
      .customization-options {
        grid-template-columns: 1fr;
      }
  
      .countdown-circle {
        width: 120px;
        height: 120px;
      }
  
      #countdown-text {
        font-size: 60px;
      }
  
      .photo-booth {
        padding: 20px;
      }
  
      h1 {
        font-size: 2.2rem;
      }
  
      /* Mobile-specific sticker controls */
      .sticker {
        cursor: pointer;
      }
  
      .sticker-container {
        touch-action: none;
      }
  
      .resize-handle {
        width: 20px;
        height: 20px;
        right: -10px;
        bottom: -10px;
      }
    }
  
    @media (max-width: 480px) {
      :root {
        --strip-display-width: 280px;
        --photo-width: 280px;
        --photo-height: 186px;
      }
  
      .photo-options {
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 15px 10px;
      }
  
      .countdown-circle {
        width: 100px;
        height: 100px;
      }
  
      #countdown-text {
        font-size: 48px;
      }
  
      .popup-buttons {
        flex-direction: column;
      }
  
      .popup-buttons .btn {
        width: 100%;
      }
  
      .filter-option {
        padding: 10px;
      }
  
      .filter-preview {
        width: 50px;
        height: 50px;
      }
  
      #qr-code {
        width: 120px;
        height: 120px;
      }
  
      .photo-preview-container {
        min-height: 300px;
      }
  
      .option-panel h3 {
        font-size: 1.1rem;
      }
  
      .preset span,
      .filter-option span {
        font-size: 0.8rem;
      }
    }
  
    /* ===== Animation Classes ===== */
    .animate {
      animation: fadeInUp 0.6s forwards;
    }
  
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  
    /* ===== Flash Effect ===== */
    .flash-overlay {
      animation: flash 0.5s ease-out;
    }
  
    @keyframes flash {
      0% {
        opacity: 0.9;
      }
      100% {
        opacity: 0;
      }
    }
  </style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // DOM Elements
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const stripCanvas = document.getElementById("strip-canvas");
    const stripCtx = stripCanvas.getContext("2d");
    const captureBtn = document.getElementById("capture-btn");
    const saveBtn = document.getElementById("save-btn");
    const qrBtn = document.getElementById("qr-btn");
    const clearStickersBtn = document.getElementById("clear-stickers-btn");
    const startBtn = document.getElementById("start-btn");
    const moreTimeBtn = document.getElementById("more-time-btn");
    const retryCameraBtn = document.getElementById("retry-camera-btn");
    const countdownText = document.getElementById("countdown-text");
    const countdownElement = document.getElementById("countdown");
    const flashOverlay = document.querySelector(".flash-overlay");
    const popupOverlay = document.getElementById("popup-overlay");
    const popupMessage = document.getElementById("popup-message");
    const popupButtons = document.getElementById("popup-buttons");
    const allPhotosText = document.getElementById("all-photos-text");
    const allPhotosCaptured = document.getElementById("all-photos-captured");
    const stripPreview = document.getElementById("strip-preview");
    const stripFrame = document.querySelector(".strip-frame");
    const photoPreviewContainer = document.getElementById(
      "photo-preview-container"
    );
    const photoPreviewSidebar = document.getElementById(
      "photo-preview-sidebar"
    );
    const dropdown = document.querySelector(".custom-dropdown");
    const selectedOption = dropdown.querySelector(".selected-option");
    const dropdownOptions = dropdown.querySelector(".dropdown-options");
    const colorOptions = document.querySelectorAll(".color-option");
    const colorPages = document.querySelectorAll(".color-page");
    const pageIndicators = document.querySelectorAll(".page-indicator");
    const presets = document.querySelectorAll(".preset");
    const stickers = document.querySelectorAll(".sticker");
    const filterOptions = document.querySelectorAll(".filter-option");
    const filterPanel = document.getElementById("filter-options");
    const customizationPanel = document.getElementById("customization-options");
    const qrCodeContainer = document.getElementById("qr-code-container");
    const qrCodeElement = document.getElementById("qr-code");
    const downloadQrBtn = document.getElementById("download-qr-btn");
    const photoOptionsSection = document.querySelector(".photo-options");
    const cameraErrorElement = document.getElementById("camera-error");
    const cameraFrame = document.getElementById("camera-frame");
    const uploadBtn = document.getElementById("upload-btn");
    const photoUpload = document.getElementById("photo-upload");

    // State variables
    let photos = [];
    let selectedValue = 3;
    let selectedColor = "#ff69b4";
    let selectedFilter = "normal";
    let isCapturing = false;
    let activeSticker = null;
    let isResizing = false;
    let startX, startY, startWidth, startHeight;
    let stickerContainers = [];
    let countdownInterval;
    let qrCodeGenerated = false;
    let cameraStream = null;
    let isMobile =
      /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
        navigator.userAgent
      ) ||
      (navigator.maxTouchPoints > 0 &&
        /iPad|Macintosh/i.test(navigator.userAgent));

    // Initialize camera with robust error handling
    async function initCamera() {
      try {
        // Stop any existing stream
        if (cameraStream) {
          cameraStream.getTracks().forEach((track) => {
            track.stop();
          });
          cameraStream = null;
        }

        cameraErrorElement.style.display = "none";
        retryCameraBtn.style.display = "none";
        captureBtn.disabled = true;

        // First try with ideal constraints
        let stream;
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280 },
              height: { ideal: 1280 },
              facingMode: "user",
            },
            audio: false,
          });
        } catch (err) {
          // If ideal constraints fail, try with more lenient constraints
          console.log("Falling back to more lenient constraints");
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "user",
            },
            audio: false,
          });
        }

        cameraStream = stream;
        video.srcObject = stream;
        video.style.display = "block";

        // Wait for video to be ready
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = () => {
            // Set canvas dimensions to match video aspect ratio
            const aspectRatio = video.videoWidth / video.videoHeight;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            video.play()
              .then(resolve)
              .catch(err => {
                console.error("Video play failed:", err);
                handleCameraError("Tap to enable camera");
                reject(err);
              });
          };

          // Add timeout for video metadata
          setTimeout(() => {
            if (!video.videoWidth) {
              reject(new Error("Video metadata not loaded"));
            }
          }, 3000);
        });

        captureBtn.disabled = false;
        return true;
      } catch (err) {
        console.error("Camera initialization error:", err);
        handleCameraError(getUserFriendlyCameraError(err));
        return false;
      }
    }

    function handleCameraError(message) {
      cameraErrorElement.style.display = "flex";
      video.style.display = "none";
      captureBtn.disabled = true;
      retryCameraBtn.style.display = "block";

      const errorText = cameraErrorElement.querySelector("p");
      if (message) {
        errorText.textContent = message;
      }
    }

    function getUserFriendlyCameraError(error) {
      if (!error) return "Could not access camera. Please try again.";

      if (error.name === "NotAllowedError") {
        return "Please allow camera permissions to use this feature";
      } else if (error.name === "NotFoundError") {
        return "No camera found on this device";
      } else if (error.name === "NotReadableError") {
        return "Camera is not accessible. Try closing other apps that might be using it.";
      } else if (error.name === "OverconstrainedError") {
        return "Camera doesn't meet requirements";
      } else if (error.name === "SecurityError") {
        return "Camera access is blocked for security reasons";
      } else if (error.message === "Video metadata not loaded") {
        return "Camera is taking too long to initialize. Please try again.";
      } else {
        return "Could not access camera. Please try again.";
      }
    }

    // Initialize file upload functionality
    function initFileUpload() {
      // Click handler for upload button
      uploadBtn.addEventListener("click", function() {
        photoUpload.click();
      });

      // File input change handler
      photoUpload.addEventListener("change", function(e) {
        const files = e.target.files;
        if (files.length === 0) return;

        // Reset photos if needed
        if (photos.length > 0) {
          resetSession();
        }

        // Process each file
        const maxPhotos = parseInt(selectedValue);
        let processedCount = 0;

        for (let i = 0; i < Math.min(files.length, maxPhotos); i++) {
          const file = files[i];
          if (!file.type.match("image.*")) continue;

          const reader = new FileReader();
          reader.onload = function(event) {
            photos.push(event.target.result);
            processedCount++;
            
            if (processedCount === Math.min(files.length, maxPhotos)) {
              updatePhotoPreviews();
              finishCaptureSession();
              showPopup(`${processedCount} photos uploaded!`, 2000, false);
            }
          };
          reader.readAsDataURL(file);
        }
      });

      // Drag and drop functionality
      photoPreviewContainer.addEventListener("dragover", function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.add("dragover");
      });

      photoPreviewContainer.addEventListener("dragleave", function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove("dragover");
      });

      photoPreviewContainer.addEventListener("drop", function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove("dragover");

        const files = e.dataTransfer.files;
        if (files.length === 0) return;

        // Reset photos if needed
        if (photos.length > 0) {
          resetSession();
        }

        // Process each file
        const maxPhotos = parseInt(selectedValue);
        let processedCount = 0;

        for (let i = 0; i < Math.min(files.length, maxPhotos); i++) {
          const file = files[i];
          if (!file.type.match("image.*")) continue;

          const reader = new FileReader();
          reader.onload = function(event) {
            photos.push(event.target.result);
            processedCount++;
            
            if (processedCount === Math.min(files.length, maxPhotos)) {
              updatePhotoPreviews();
              finishCaptureSession();
              showPopup(`${processedCount} photos uploaded!`, 2000, false);
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    retryCameraBtn.addEventListener("click", async function () {
      await initCamera();
    });

    function initDropdown() {
      selectedOption.addEventListener("click", function () {
        dropdownOptions.style.display =
          dropdownOptions.style.display === "block" ? "none" : "block";
        const icon = this.querySelector("i");
        icon.style.transform =
          dropdownOptions.style.display === "block"
            ? "rotate(180deg)"
            : "rotate(0)";
      });

      dropdownOptions.querySelectorAll("li").forEach((option) => {
        option.addEventListener("click", function () {
          selectedOption.querySelector("span").textContent = this.textContent;
          selectedValue = parseInt(this.getAttribute("data-value")) || 3;
          dropdownOptions.style.display = "none";
          selectedOption.querySelector("i").style.transform = "rotate(0)";

          dropdownOptions.querySelectorAll("li").forEach((li) => {
            li.classList.remove("selected");
          });
          this.classList.add("selected");

          if (
            (selectedValue === 1 && photos.length > 1) ||
            (selectedValue > 1 && photos.length > 0)
          ) {
            resetSession();
          }
        });
      });

      document.addEventListener("click", function (e) {
        if (!dropdown.contains(e.target)) {
          dropdownOptions.style.display = "none";
          selectedOption.querySelector("i").style.transform = "rotate(0)";
        }
      });
    }

    function initFilterOptions() {
      filterOptions.forEach((filter) => {
        filter.addEventListener("click", function () {
          filterOptions.forEach((f) => f.classList.remove("selected"));
          this.classList.add("selected");
          selectedFilter = this.getAttribute("data-filter") || "normal";
        });
      });
    }

    function initColorOptions() {
      pageIndicators.forEach((indicator) => {
        indicator.addEventListener("click", function () {
          const page = this.getAttribute("data-page");
          showColorPage(page);
        });
      });

      colorOptions.forEach((color) => {
        color.addEventListener("click", function () {
          colorOptions.forEach((c) => c.classList.remove("selected"));
          this.classList.add("selected");
          selectedColor = this.getAttribute("data-color") || "#ff69b4";

          if (photos.length > 0) {
            generateStripPreview();
          }
        });
      });
    }

    function showColorPage(page) {
      colorPages.forEach((p) => {
        if (p.getAttribute("data-page") === page) {
          p.classList.add("active");
        } else {
          p.classList.remove("active");
        }
      });

      pageIndicators.forEach((indicator) => {
        if (indicator.getAttribute("data-page") === page) {
          indicator.classList.add("active");
        } else {
          indicator.classList.remove("active");
        }
      });
    }

    function initStickers() {
      stickers.forEach((sticker) => {
        // For desktop - drag and drop
        sticker.addEventListener("dragstart", function (e) {
          e.dataTransfer.setData("text/plain", this.src);
        });

        // For both desktop and mobile - click to add
        sticker.addEventListener("click", function () {
          const rect = stripFrame.getBoundingClientRect();
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          createStickerContainer(this.src, centerX, centerY, 80, 80);
          showPopup("Sticker added! Drag to position", 1500, false);
        });
      });

      stripFrame.addEventListener("dragover", function (e) {
        e.preventDefault();
      });

      stripFrame.addEventListener("drop", function (e) {
        e.preventDefault();
        const stickerSrc = e.dataTransfer.getData("text/plain");
        if (stickerSrc) {
          const rect = this.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          createStickerContainer(stickerSrc, x, y);
        }
      });
    }

    function createStickerContainer(src, x, y, width = 50, height = 50) {
      const container = document.createElement("div");
      container.className = "sticker-container";
      container.style.position = "absolute";
      container.style.left = `${x - width / 2}px`;
      container.style.top = `${y - height / 2}px`;
      container.style.width = `${width}px`;
      container.style.height = `${height}px`;
      container.style.zIndex = "10";
      container.style.cursor = "move";

      const img = document.createElement("img");
      img.src = src;
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.pointerEvents = "none";
      img.style.userSelect = "none";

      const resizeHandle = document.createElement("div");
      resizeHandle.className = "resize-handle";
      resizeHandle.style.position = "absolute";
      resizeHandle.style.width = isMobile ? "20px" : "12px";
      resizeHandle.style.height = isMobile ? "20px" : "12px";
      resizeHandle.style.background = "white";
      resizeHandle.style.border = "2px solid var(--pink)";
      resizeHandle.style.borderRadius = "50%";
      resizeHandle.style.right = isMobile ? "-10px" : "-6px";
      resizeHandle.style.bottom = isMobile ? "-10px" : "-6px";
      resizeHandle.style.cursor = "nwse-resize";
      resizeHandle.style.zIndex = "11";

      container.appendChild(img);
      container.appendChild(resizeHandle);
      stripFrame.appendChild(container);

      setupStickerInteractions(container, resizeHandle);
      stickerContainers.push(container);
      return container;
    }

    function setupStickerInteractions(container, resizeHandle) {
      // Common functions for both mouse and touch
      function startMoving(e) {
        e.preventDefault();
        activeSticker = container;
        container.style.boxShadow = "0 0 15px rgba(255,105,180,0.7)";

        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        startX = clientX;
        startY = clientY;
        const rect = container.getBoundingClientRect();
        const offsetX = startX - rect.left;
        const offsetY = startY - rect.top;

        function moveSticker(e) {
          if (!activeSticker) return;
          const previewRect = stripFrame.getBoundingClientRect();
          const currentX = e.clientX || e.touches[0].clientX;
          const currentY = e.clientY || e.touches[0].clientY;
          
          // Calculate new position relative to strip frame
          let newX = currentX - offsetX - previewRect.left;
          let newY = currentY - offsetY - previewRect.top;

          // Constrain to strip frame boundaries
          const maxX = stripFrame.offsetWidth - container.offsetWidth;
          const maxY = stripFrame.offsetHeight - container.offsetHeight;

          container.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
          container.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
        }

        function stopMoving() {
          document.removeEventListener("mousemove", moveSticker);
          document.removeEventListener("touchmove", moveSticker);
          document.removeEventListener("mouseup", stopMoving);
          document.removeEventListener("touchend", stopMoving);
          if (activeSticker) {
            activeSticker.style.boxShadow = "none";
            activeSticker = null;
          }
        }

        document.addEventListener("mousemove", moveSticker);
        document.addEventListener("touchmove", moveSticker, { passive: false });
        document.addEventListener("mouseup", stopMoving);
        document.addEventListener("touchend", stopMoving);
      }

      // Mouse events
      container.addEventListener("mousedown", function (e) {
        if (e.target === container || e.target === container.querySelector("img")) {
          startMoving(e);
        }
      });

      // Touch events for mobile
      container.addEventListener("touchstart", function (e) {
        if (e.target === container || e.target === container.querySelector("img")) {
          startMoving(e);
        }
      }, { passive: false });

      // Resize handle interactions
      function startResizing(e) {
        e.stopPropagation();
        e.preventDefault();
        isResizing = true;
        activeSticker = container;
        container.style.boxShadow = "0 0 15px rgba(255,105,180,0.7)";

        const clientX = e.clientX || e.touches[0].clientX;
        const clientY = e.clientY || e.touches[0].clientY;

        startX = clientX;
        startY = clientY;
        startWidth = parseInt(container.style.width);
        startHeight = parseInt(container.style.height);

        function resizeSticker(e) {
          if (!isResizing || !activeSticker) return;

          const currentX = e.clientX || e.touches[0].clientX;
          const currentY = e.clientY || e.touches[0].clientY;
          const width = startWidth + (currentX - startX);
          const height = startHeight + (currentY - startY);

          const minSize = isMobile ? 40 : 20;
          const newWidth = Math.max(minSize, width);
          const newHeight = Math.max(minSize, height);

          container.style.width = `${newWidth}px`;
          container.style.height = `${newHeight}px`;
        }

        function stopResizing() {
          isResizing = false;
          document.removeEventListener("mousemove", resizeSticker);
          document.removeEventListener("touchmove", resizeSticker);
          document.removeEventListener("mouseup", stopResizing);
          document.removeEventListener("touchend", stopResizing);
          if (activeSticker) {
            activeSticker.style.boxShadow = "none";
            activeSticker = null;
          }
        }

        document.addEventListener("mousemove", resizeSticker);
        document.addEventListener("touchmove", resizeSticker, { passive: false });
        document.addEventListener("mouseup", stopResizing);
        document.addEventListener("touchend", stopResizing);
      }

      // Mouse events for resize
      resizeHandle.addEventListener("mousedown", startResizing);

      // Touch events for resize on mobile
      resizeHandle.addEventListener("touchstart", startResizing, {
        passive: false,
      });
    }

    function showPopup(message, duration = 0, showButtons = false) {
      popupMessage.textContent = message;
      popupOverlay.style.display = "flex";
      popupButtons.style.display = showButtons ? "flex" : "none";

      if (duration > 0) {
        setTimeout(hidePopup, duration);
      }
    }

    function hidePopup() {
      popupOverlay.style.display = "none";
    }

    startBtn.addEventListener("click", () => {
      hidePopup();
      startCountdown();
    });

    moreTimeBtn.addEventListener("click", hidePopup);

    captureBtn.addEventListener("click", async function () {
      if (!video.srcObject || video.paused) {
        showPopup("Camera not ready. Please wait...", 2000, false);
        try {
          await initCamera();
        } catch (e) {
          console.error("Camera initialization failed:", e);
        }
        return;
      }

      if (isCapturing) {
        showPopup("Already capturing!", 1500, false);
        return;
      }

      if (photos.length > 0) {
        resetSession();
        filterPanel.style.display = "grid";
        customizationPanel.style.display = "none";
        clearStickersBtn.style.display = "none";
        saveBtn.style.display = "none";
        qrBtn.style.display = "none";
        return;
      }

      const photoCount = parseInt(selectedValue);

      if (photos.length >= photoCount) {
        showPopup(`Maximum ${photoCount} photos captured!`, 2000, false);
        return;
      }

      if (photos.length === 0) {
        showPopup("Get ready! First photo in 3 seconds!", 0, true);
      } else {
        startCountdown();
      }
    });

    function startCountdown() {
      isCapturing = true;
      captureBtn.disabled = true;
      let count = 3;

      countdownElement.style.opacity = "1";
      countdownText.textContent = count;

      countdownInterval = setInterval(() => {
        count--;
        countdownText.textContent = count > 0 ? count : "CHEESE!";

        if (count === 0) {
          clearInterval(countdownInterval);

          setTimeout(async () => {
            if (video.paused) {
              try {
                await video.play();
              } catch (e) {
                console.error("Video play failed:", e);
                resetCapture();
                return;
              }
            }

            await capturePhoto();
            countdownElement.style.opacity = "0";

            if (photos.length < parseInt(selectedValue)) {
              startCountdown();
            } else {
              finishCaptureSession();
            }
          }, 300);
        }
      }, 1000);
    }

    function applyFilter(imageData) {
      const data = imageData.data;

      switch (selectedFilter) {
        case "grayscale":
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
          }
          break;

        case "sepia":
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];

            data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
            data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
            data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
          }
          break;

        case "invert":
          for (let i = 0; i < data.length; i += 4) {
            data[i] = 255 - data[i];
            data[i + 1] = 255 - data[i + 1];
            data[i + 2] = 255 - data[i + 2];
          }
          break;
      }

      return imageData;
    }

    async function capturePhoto() {
      try {
        if (!video || video.readyState < 2) {
          throw new Error("Video not ready");
        }

        // Set canvas dimensions to match video resolution
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw the image with mirror effect
        ctx.save();
        ctx.scale(-1, 1);
        ctx.drawImage(
          video,
          -video.videoWidth,
          0,
          video.videoWidth,
          video.videoHeight
        );
        ctx.restore();

        if (selectedFilter !== "normal") {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const filteredData = applyFilter(imageData);
          ctx.putImageData(filteredData, 0, 0);
        }

        // Trigger flash effect
        if (flashOverlay) {
          flashOverlay.style.animation = "none";
          void flashOverlay.offsetWidth; // Trigger reflow
          flashOverlay.style.animation = "flash 0.5s ease-out";
        }

        // Get the image data and add to photos array
        const photoData = canvas.toDataURL("image/png");
        photos.push(photoData);

        updatePhotoPreviews();
      } catch (error) {
        console.error("Capture failed:", error);
        showPopup("Capture failed. Please try again.", 2000, false);
        resetCapture();
      }
    }

    function updatePhotoPreviews() {
      photoPreviewContainer.innerHTML = "";

      if (photos.length === 0) {
        photoPreviewContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-camera"></i>
                        <p>Your photos will appear here</p>
                    </div>
                `;
        return;
      }

      photos.forEach((photo, index) => {
        const previewDiv = document.createElement("div");
        previewDiv.className = "photo-preview-item animate";
        previewDiv.innerHTML = `
                    <div class="photo-preview-number">${index + 1}</div>
                    <img src="${photo}" class="photo-preview" alt="Photo ${
          index + 1
        }">
                `;
        photoPreviewContainer.appendChild(previewDiv);
      });
    }

    function resetCapture() {
      isCapturing = false;
      captureBtn.disabled = false;
      countdownElement.style.opacity = "0";
      if (countdownInterval) clearInterval(countdownInterval);
    }

    function resetSession() {
      photos = [];
      updatePhotoPreviews();
      stripPreview.style.display = "none";
      allPhotosCaptured.style.display = "none";
      video.style.display = "block";
      cameraFrame.style.display = "block";
      photoPreviewSidebar.style.display = "block";
      photoOptionsSection.style.display = "flex";
      stickerContainers.forEach((container) => {
        container.remove();
      });
      stickerContainers = [];
      qrCodeContainer.style.display = "none";
      qrCodeElement.innerHTML = "";
      qrCodeGenerated = false;
    }

    async function finishCaptureSession() {
      isCapturing = false;
      allPhotosText.textContent = `All ${photos.length} photos captured!`;
      allPhotosCaptured.style.display = "block";

      try {
        await generateStripPreview();
        stripPreview.style.display = "block";
        video.style.display = "none";
        cameraFrame.style.display = "none";
        photoPreviewSidebar.style.display = "none";
        photoOptionsSection.style.display = "none";
        captureBtn.disabled = false;

        filterPanel.style.display = "none";
        customizationPanel.style.display = "grid";
        clearStickersBtn.style.display = "block";
        saveBtn.style.display = "block";
        qrBtn.style.display = "block";
      } catch (error) {
        console.error("Preview generation failed:", error);
        showPopup("Couldn't generate preview", 2000, false);
      }
    }

    async function generateStripPreview() {
      return new Promise((resolve) => {
        // Calculate dimensions based on device pixel ratio for high DPI displays
        const pixelRatio = window.devicePixelRatio || 1;
        const targetWidth = 1200 * pixelRatio;
        const targetHeight = 800 * pixelRatio;
        const spacing = 15 * pixelRatio;
        const stripPadding = 60 * pixelRatio; // Increased padding
        const borderWidth = 40 * pixelRatio;
        const bottomMargin = 180 * pixelRatio; // Increased margin for text
        const sideMargin = 40 * pixelRatio; // Added side margin

        // Calculate total strip height based on number of photos
        const stripHeight = 
          (targetHeight + spacing) * photos.length - 
          spacing + 
          stripPadding * 2 + 
          bottomMargin;

        // Set canvas dimensions (actual pixels)
        stripCanvas.width = targetWidth + sideMargin * 2 + borderWidth * 2;
        stripCanvas.height = stripHeight + borderWidth * 2;

        // Set CSS dimensions (display size) using our variables
        const displayWidth = isMobile 
          ? parseInt(getComputedStyle(document.documentElement).getPropertyValue('--strip-display-mobile'))
          : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--strip-display-width'));
        
        stripCanvas.style.width = `${displayWidth}px`;
        stripCanvas.style.height = `${(stripHeight / targetWidth) * displayWidth}px`;

        stripCtx.clearRect(0, 0, stripCanvas.width, stripCanvas.height);

        // Draw the white border background
        stripCtx.fillStyle = "white";
        stripCtx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);

        // Handle different background types
        if (selectedColor.startsWith("url(")) {
          const patternImg = new Image();
          patternImg.crossOrigin = "Anonymous";
          patternImg.onload = () => {
            // First draw the background pattern
            const pattern = stripCtx.createPattern(patternImg, "repeat");
            stripCtx.fillStyle = pattern;
            stripCtx.fillRect(
              borderWidth,
              borderWidth,
              stripCanvas.width - borderWidth * 2,
              stripCanvas.height - borderWidth * 2
            );
            
            // Then draw the photos on top
            drawPhotosAndStickers();
          };
          patternImg.onerror = () => {
            console.error("Failed to load pattern image");
            // Fallback to pink color if pattern fails to load
            stripCtx.fillStyle = "#ff69b4";
            stripCtx.fillRect(
              borderWidth,
              borderWidth,
              stripCanvas.width - borderWidth * 2,
              stripCanvas.height - borderWidth * 2
            );
            drawPhotosAndStickers();
          };
          patternImg.src = selectedColor.match(/url\(['"]?(.*?)['"]?\)/)[1];
        } else if (selectedColor.startsWith("linear-gradient")) {
          try {
            const gradientParams = selectedColor.match(
              /linear-gradient\((.+)\)/
            )[1];
            const parts = gradientParams.split(/,(?=\s*(?:#|rgb|hsl|var))/);

            let angle = 135;
            const angleMatch = parts[0].match(/(\d+)deg/);
            if (angleMatch) {
              angle = parseInt(angleMatch[1]);
              parts.shift();
            }

            const angleRad = ((angle - 90) * Math.PI) / 180;
            const length = Math.sqrt(
              stripCanvas.width * stripCanvas.width +
                stripCanvas.height * stripCanvas.height
            );
            const x1 =
              stripCanvas.width / 2 - (Math.cos(angleRad) * length) / 2;
            const y1 =
              stripCanvas.height / 2 - (Math.sin(angleRad) * length) / 2;
            const x2 =
              stripCanvas.width / 2 + (Math.cos(angleRad) * length) / 2;
            const y2 =
              stripCanvas.height / 2 + (Math.sin(angleRad) * length) / 2;

            const gradient = stripCtx.createLinearGradient(x1, y1, x2, y2);

            parts.forEach((stop, i) => {
              const color = stop.trim();
              const pos = i / (parts.length - 1);
              gradient.addColorStop(pos, color);
            });

            stripCtx.fillStyle = gradient;
            stripCtx.fillRect(
              borderWidth,
              borderWidth,
              stripCanvas.width - borderWidth * 2,
              stripCanvas.height - borderWidth * 2
            );
            drawPhotosAndStickers();
          } catch (e) {
            console.error("Error creating gradient:", e);
            stripCtx.fillStyle = "#ff69b4";
            stripCtx.fillRect(
              borderWidth,
              borderWidth,
              stripCanvas.width - borderWidth * 2,
              stripCanvas.height - borderWidth * 2
            );
            drawPhotosAndStickers();
          }
        } else {
          // Solid color
          stripCtx.fillStyle = selectedColor;
          stripCtx.fillRect(
            borderWidth,
            borderWidth,
            stripCanvas.width - borderWidth * 2,
            stripCanvas.height - borderWidth * 2
          );
          drawPhotosAndStickers();
        }

        function drawPhotosAndStickers() {
          // Create an array of promises for loading all photos
          const photoPromises = photos.map((photo, index) => {
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => {
                // Center the photo horizontally with border padding and side margin
                const x =
                  borderWidth + sideMargin +
                  (stripCanvas.width - borderWidth * 2 - sideMargin * 2 - targetWidth) / 2;

                // Calculate y position based on photo index with border padding
                const y =
                  borderWidth + stripPadding + (targetHeight + spacing) * index;

                // Draw the photo with rectangular dimensions
                stripCtx.drawImage(
                  img,
                  0,
                  0,
                  img.width,
                  img.height,
                  x,
                  y,
                  targetWidth,
                  targetHeight
                );
                resolve();
              };
              img.onerror = () => {
                console.error("Failed to load photo for strip");
                resolve();
              };
              img.src = photo;
            });
          });

          // Wait for all photos to load and draw
          Promise.all(photoPromises).then(() => {
            // Add stickers to the strip
            stickerContainers.forEach((container) => {
              const img = container.querySelector("img");
              if (!img) return;

              const rect = container.getBoundingClientRect();
              const previewRect = stripFrame.getBoundingClientRect();

              const x = borderWidth + sideMargin + (rect.left - previewRect.left) * pixelRatio;
              const y = borderWidth + (rect.top - previewRect.top) * pixelRatio;
              const width = parseInt(container.style.width) * pixelRatio;
              const height = parseInt(container.style.height) * pixelRatio;

              const tempImg = new Image();
              tempImg.onload = () => {
                stripCtx.drawImage(tempImg, x, y, width, height);
              };
              tempImg.src = img.src;
            });

            addStripMetadata();
            resolve();
          });
        }
      });
    }

    function addStripMetadata() {
      const now = new Date();
      const date = now.toLocaleDateString();
      const time = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });

      stripCtx.fillStyle = "#000";
      stripCtx.font = `bold ${36 * (window.devicePixelRatio || 1)}px 'Montserrat', sans-serif`; // Increased font size
      stripCtx.textAlign = "center";

      const text = `${date} ${time} - PicoBooth`;
      const textX = stripCanvas.width / 2;
      const textY = stripCanvas.height - (60 * (window.devicePixelRatio || 1)); // Adjusted position for larger font

      // Add text shadow for better visibility
      stripCtx.shadowColor = "rgba(255,255,255,0.7)";
      stripCtx.shadowBlur = 5 * (window.devicePixelRatio || 1);
      stripCtx.shadowOffsetX = 1 * (window.devicePixelRatio || 1);
      stripCtx.shadowOffsetY = 1 * (window.devicePixelRatio || 1);

      stripCtx.fillText(text, textX, textY);

      // Reset shadow
      stripCtx.shadowColor = "transparent";
    }

    function generateQRCode() {
      if (qrCodeGenerated) {
        qrCodeContainer.style.display =
          qrCodeContainer.style.display === "block" ? "none" : "block";
        return;
      }

      try {
        const uniqueId =
          Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const qrData = `${window.location.origin}${window.location.pathname}?strip=${uniqueId}`;

        qrCodeElement.innerHTML = "";

        const qr = qrcode(0, "H");
        qr.addData(qrData);
        qr.make();

        const qrSize = 150;
        const qrCanvas = document.createElement("canvas");
        qrCanvas.width = qrSize;
        qrCanvas.height = qrSize;
        const qrCtx = qrCanvas.getContext("2d");

        const moduleCount = qr.getModuleCount();
        const moduleSize = qrSize / moduleCount;

        qrCtx.fillStyle = "#ffffff";
        qrCtx.fillRect(0, 0, qrSize, qrSize);

        qrCtx.fillStyle = "#000000";
        for (let row = 0; row < moduleCount; row++) {
          for (let col = 0; col < moduleCount; col++) {
            if (qr.isDark(row, col)) {
              qrCtx.fillRect(
                col * moduleSize,
                row * moduleSize,
                moduleSize,
                moduleSize
              );
            }
          }
        }

        qrCodeElement.appendChild(qrCanvas);
        qrCodeContainer.style.display = "block";
        qrCodeGenerated = true;

        localStorage.setItem(
          `picobooth_${uniqueId}`,
          stripCanvas.toDataURL("image/png")
        );
      } catch (error) {
        console.error("QR code generation failed:", error);
        showPopup("Failed to generate QR code. Please try again.", 2000, false);
      }
    }

    saveBtn.addEventListener("click", async function () {
      if (photos.length === 0) {
        showPopup("No photos to save!", 1500, false);
        return;
      }

      try {
        await generateStripPreview();

        // Create a high-resolution version for printing
        const printWidth = 1200;
        const printRatio = printWidth / stripCanvas.width;
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = printWidth;
        tempCanvas.height = stripCanvas.height * printRatio;
        const tempCtx = tempCanvas.getContext("2d");

        tempCtx.imageSmoothingEnabled = true;
        tempCtx.drawImage(
          stripCanvas,
          0,
          0,
          stripCanvas.width,
          stripCanvas.height,
          0,
          0,
          tempCanvas.width,
          tempCanvas.height
        );

        const link = document.createElement("a");
        const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        link.download = `picobooth-${timestamp}.png`;
        link.href = tempCanvas.toDataURL("image/png", 1.0);

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showPopup("Photo strip saved!", 1500, false);
      } catch (error) {
        console.error("Save failed:", error);
        showPopup("Save failed. Please try again.", 2000, false);
      }
    });

    qrBtn.addEventListener("click", function () {
      if (photos.length === 0) {
        showPopup("No photos to generate QR code for!", 1500, false);
        return;
      }
      generateQRCode();
    });

    downloadQrBtn.addEventListener("click", async function () {
      if (!qrCodeGenerated) {
        showPopup("Please generate QR code first", 1500, false);
        return;
      }

      try {
        const qrCanvas = qrCodeElement.querySelector("canvas");
        if (!qrCanvas) {
          throw new Error("QR code canvas not found");
        }

        const dataURL = qrCanvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataURL;
        a.download = "picobooth-qr.png";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (error) {
        console.error("QR download failed:", error);
        showPopup("Failed to download QR code", 2000, false);
      }
    });

    clearStickersBtn.addEventListener("click", function () {
      stickerContainers.forEach((container) => {
        container.remove();
      });
      stickerContainers = [];

      if (photos.length > 0) {
        generateStripPreview();
      }
    });

    function initPresets() {
      presets.forEach((preset) => {
        preset.addEventListener("click", function () {
          const color = this.getAttribute("data-color");
          const stickersAttr = this.getAttribute("data-stickers");

          stickerContainers.forEach((container) => {
            container.remove();
          });
          stickerContainers = [];

          colorOptions.forEach((c) => {
            c.classList.remove("selected");
          });
          const selectedColorOption = document.querySelector(
            `.color-option[data-color="${color}"]`
          );
          if (selectedColorOption) {
            selectedColorOption.classList.add("selected");
          }

          selectedColor = color;

          try {
            const stickerFiles = stickersAttr
              .split(",")
              .filter((file) => file.trim());

            stickerFiles.forEach((file) => {
              const stickerSrc = `{{ url_for('static', filename='') }}${file.trim()}`;

              const positions = [
                [50, 50],
                [stripCanvas.width - 50, 50],
                [50, stripCanvas.height - 50],
                [stripCanvas.width - 50, stripCanvas.height - 50],
              ];

              positions.forEach((pos) => {
                createStickerContainer(stickerSrc, pos[0], pos[1], 60, 60);
              });
            });

            if (photos.length > 0) {
              generateStripPreview().catch((e) =>
                console.error("Preview error:", e)
              );
            }

            const presetName =
              this.querySelector("span").textContent || "theme";
            showPopup(`Applied ${presetName}!`, 1500, false);
          } catch (error) {
            console.error("Error applying preset:", error);
            showPopup("Couldn't apply preset", 1500, false);
          }
        });
      });
    }

    // Initialize all components
    function initializeAll() {
      initDropdown();
      initFilterOptions();
      initColorOptions();
      initStickers();
      initPresets();
      initFileUpload();

      // Add click handler to video element to help with mobile camera activation
      video.addEventListener("click", function () {
        if (!video.srcObject) {
          initCamera();
        }
      });

      // Initialize camera after a short delay to allow other elements to load
      setTimeout(() => {
        initCamera();
      }, 500);
    }

    // Start initialization
    if (document.readyState === "complete") {
      initializeAll();
    } else {
      window.addEventListener("load", initializeAll);
    }

    // Clean up on page unload
    window.addEventListener("beforeunload", function () {
      if (cameraStream) {
        cameraStream.getTracks().forEach((track) => track.stop());
      }
    });

    // Handle page visibility changes
    document.addEventListener("visibilitychange", function () {
      if (!document.hidden && !video.srcObject) {
        initCamera();
      }
    });

    // Add touch support for mobile devices
    document.addEventListener(
      "touchend",
      function (e) {
        if (e.target === video && !video.srcObject) {
          initCamera();
        }
      },
      { passive: true }
    );
  });
</script>

{% endblock %}
{% extends "base.html" %}

{% block title %}Photo Booth{% endblock %}

{% block content %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Chewy&display=swap" rel="stylesheet">
<!-- QR Code library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<div class="photo-booth-container">
    <div class="photo-booth">
        <div class="header-section">
            <h1><i class="fas fa-camera-retro"></i> PicoBooth</h1>
            <p class="subtitle">Capture your fun moments and create magical photo strips!</p>
            
            <!-- Photo Options -->
            <div class="photo-options">
                <label>Number of Photos:</label>
                <div class="custom-dropdown">
                    <div class="selected-option">
                        <span>3</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <ul class="dropdown-options">
                        <li data-value="1">1 (Large Photo)</li>
                        <li data-value="3" class="selected">3</li>
                        <li data-value="4">4</li>
                        <li data-value="5">5</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="photo-session-container">
            <!-- Camera Feed -->
            <div class="control-panel">
                <div class="camera-container">
                    <div class="camera-frame" id="camera-frame">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas" style="display:none;"></canvas>
                        <div id="countdown" class="countdown">
                            <div class="countdown-circle">
                                <span id="countdown-text"></span>
                            </div>
                        </div>
                        <div class="flash-overlay"></div>
                        <div id="camera-error" class="camera-error" style="display: none;">
                            <i class="fas fa-camera-slash"></i>
                            <p>Camera not available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photo Preview Sidebar -->
            <div id="photo-preview-sidebar" class="photo-preview-sidebar">
                <h3><i class="fas fa-images"></i> Your Photos</h3>
                <div id="photo-preview-container" class="photo-preview-container">
                    <div class="preview-placeholder">
                        <i class="fas fa-camera"></i>
                        <p>Your photos will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strip Preview Area -->
        <div class="preview-section">
            <div id="strip-preview" class="strip-preview" style="display:none;">
                <div class="strip-frame">
                    <canvas id="strip-canvas"></canvas>
                </div>
                <div id="qr-code-container" style="display: none; text-align: center; margin-top: 20px;">
                    <div id="qr-code"></div>
                    <p>Scan to download to your phone</p>
                    <button id="download-qr-btn" class="btn btn-primary" style="margin-top: 10px;">
                        <i class="fas fa-download"></i> Download QR Code
                    </button>
                </div>
            </div>
            
            <div id="all-photos-captured" class="all-photos-captured">
                <span id="all-photos-text"></span>
            </div>

            <!-- Main Controls -->
            <div class="main-controls">
                <button id="capture-btn" class="btn btn-primary pulse-animation" disabled>
                    <i class="fas fa-camera"></i> Capture Photo
                </button>
                <button id="clear-stickers-btn" class="btn btn-danger" style="display:none;">
                    <i class="fas fa-trash-alt"></i> Clear Stickers
                </button>
                <button id="save-btn" class="btn btn-success" style="display:none;">
                    <i class="fas fa-download"></i> Save Strip
                </button>
                <button id="qr-btn" class="btn btn-info" style="display:none;">
                    <i class="fas fa-qrcode"></i> Get QR Code
                </button>
                <button id="retry-camera-btn" class="btn btn-warning" style="display:none;">
                    <i class="fas fa-sync-alt"></i> Retry Camera
                </button>
            </div>
        </div>

        <!-- Filter Options -->
        <div id="filter-options" class="customization-options">
            <div class="option-panel filter-panel">
                <h3><i class="fas fa-sliders-h"></i> Apply Filters</h3>
                <div class="filters">
                    <div class="filter-option" data-filter="normal">
                        <div class="filter-preview" style="background:linear-gradient(135deg,#ff69b4,#ff8ac5);"></div>
                        <span>Vibrant</span>
                    </div>
                    <div class="filter-option" data-filter="grayscale">
                        <div class="filter-preview" style="background:linear-gradient(135deg,#777,#999);"></div>
                        <span>Classic</span>
                    </div>
                    <div class="filter-option" data-filter="sepia">
                        <div class="filter-preview" style="background:linear-gradient(135deg,#704214,#8b5a2b);"></div>
                        <span>Vintage</span>
                    </div>
                    <div class="filter-option" data-filter="invert">
                        <div class="filter-preview" style="background:linear-gradient(135deg,#000,#222);"></div>
                        <span>Invert</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customization Options -->
        <div id="customization-options" class="customization-options" style="display:none;">
            <!-- Stickers Panel -->
            <div class="option-panel sticker-panel">
                <h3><i class="fas fa-sticky-note"></i> Add Stickers</h3>
                <div class="stickers">
                    <img src="{{ url_for('static', filename='sticker1.png') }}" alt="Sticker 1" class="sticker" draggable="true">
                    <img src="{{ url_for('static', filename='sticker2.png') }}" alt="Sticker 2" class="sticker" draggable="true">
                    <img src="{{ url_for('static', filename='sticker3.png') }}" alt="Sticker 3" class="sticker" draggable="true">
                </div>
            </div>

            <!-- Color Options -->
            <div class="option-panel color-options">
                <h3><i class="fas fa-palette"></i> Strip Color</h3>
                <div class="color-pagination">
                    <span class="page-indicator active" data-page="1"></span>
                    <span class="page-indicator" data-page="2"></span>
                </div>
                <div class="colors color-page active" data-page="1">
                    <div class="color-option selected" data-color="#ff69b4" style="background-color:#ff69b4;"></div>
                    <div class="color-option" data-color="#77dd77" style="background-color:#77dd77;"></div>
                    <div class="color-option" data-color="#87ceeb" style="background-color:#87ceeb;"></div>
                    <div class="color-option" data-color="#ffd700" style="background-color:#ffd700;"></div>
                    <div class="color-option" data-color="#ffffff" style="background-color:#ffffff;border:1px solid #ddd;"></div>
                </div>
                <div class="colors color-page" data-page="2">
                    <div class="color-option" data-color="linear-gradient(135deg, #77dd77, #ffffff)" style="background:linear-gradient(135deg, #77dd77, #ffffff);"></div>
                    <div class="color-option" data-color="linear-gradient(135deg, #87ceeb, #ffffff)" style="background:linear-gradient(135deg, #87ceeb, #ffffff);"></div>
                    <div class="color-option" data-color="linear-gradient(135deg, #ff69b4, #ffc0d9)" style="background:linear-gradient(135deg, #ff69b4, #ffc0d9);"></div>
                    <div class="color-option" data-color="linear-gradient(135deg, #ffd700, #ffffff)" style="background:linear-gradient(135deg, #ffd700, #ffffff);"></div>
                    <div class="color-option" data-color="linear-gradient(135deg, #9d7a8f, #d8bfd8)" style="background:linear-gradient(135deg, #9d7a8f, #d8bfd8);"></div>
                </div>
            </div>

            <!-- Preset Themes -->
            <div class="option-panel preset-options">
                <h3><i class="fas fa-magic"></i> Quick Themes</h3>
                <div class="presets">
                    <div class="preset" data-color="#ff69b4" data-stickers="sticker1.png,sticker2.png">
                        <div class="preset-color" style="background-color:#ff69b4;"></div>
                        <span>Pink Party</span>
                    </div>
                    <div class="preset" data-color="#77dd77" data-stickers="sticker2.png,sticker3.png">
                        <div class="preset-color" style="background-color:#77dd77;"></div>
                        <span>Green Groove</span>
                    </div>
                    <div class="preset" data-color="#87ceeb" data-stickers="sticker1.png,sticker3.png">
                        <div class="preset-color" style="background-color:#87ceeb;"></div>
                        <span>Blue Bliss</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popup Modal -->
        <div id="popup-overlay" class="popup-overlay">
            <div class="popup-panel">
                <p id="popup-message"></p>
                <div class="popup-buttons" id="popup-buttons">
                    <button id="start-btn" class="btn btn-primary">
                        <i class="fas fa-play"></i> Start
                    </button>
                    <button id="more-time-btn" class="btn btn-secondary">
                        <i class="fas fa-clock"></i> More Time
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== Base Styles ===== */
    :root {
        --pink: #FF6B9D;
        --pink-light: #FFC0D9;
        --pink-lighter: #FFE6EE;
        --purple: #9D7A8F;
        --purple-dark: #5E2E53;
        --green: #77DD77;
        --blue: #87CEEB;
        --yellow: #FFD700;
        --info: #17a2b8;
        --warning: #ffc107;
        --strip-width: 400px;
        --photo-size: 350px;
    }

    body {
        font-family: 'Montserrat', sans-serif;
        background-color: #f8f9fa;
        margin: 0;
        padding: 0;
        line-height: 1.6;
        touch-action: manipulation;
    }
    
    .photo-booth-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .photo-booth {
        background-color: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        padding: 30px;
        position: relative;
    }
    
    /* ===== Header Section ===== */
    .header-section {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
        z-index: 1;
    }
    
    h1 {
        color: var(--purple-dark);
        font-family: 'Chewy', cursive;
        font-size: 2.8rem;
        margin-bottom: 5px;
        text-shadow: 2px 2px 0 rgba(255,255,255,0.5);
        background: linear-gradient(135deg, var(--pink), var(--green), var(--blue));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .subtitle {
        text-align: center;
        color: var(--purple);
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: 500;
    }
    
    /* ===== Photo Options ===== */
    .photo-options {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        justify-content: center;
        background: var(--pink-lighter);
        padding: 15px;
        border-radius: 50px;
        max-width: 400px;
        margin: 0 auto;
        box-shadow: 0 4px 15px rgba(255,107,157,0.1);
        position: relative;
        z-index: 1001;
    }
    
    .photo-options label {
        font-weight: 600;
        color: var(--purple-dark);
        margin: 0;
    }
    
    /* ===== Modern Dropdown ===== */
    .custom-dropdown {
        position: relative;
        display: inline-block;
        width: 100px;
        z-index: 1002;
    }
    
    .selected-option {
        padding: 10px 15px;
        background-color: white;
        border: 2px solid var(--pink);
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: var(--purple-dark);
    }
    
    .selected-option:hover {
        background-color: var(--pink-lighter);
        transform: translateY(-2px);
    }
    
    .selected-option i {
        font-size: 12px;
        transition: transform 0.3s;
    }
    
    .dropdown-options {
        position: absolute;
        width: 100%;
        background: white;
        border: 2px solid var(--pink);
        border-radius: 15px;
        margin-top: 10px;
        display: none;
        z-index: 1003;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        list-style: none;
        padding: 10px 0;
        animation: fadeIn 0.3s ease-out;
    }
    
    .dropdown-options li {
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
        color: var(--purple-dark);
    }
    
    .dropdown-options li:hover {
        background-color: var(--pink-light);
        color: white;
    }
    
    .dropdown-options li.selected {
        background-color: var(--pink);
        color: white;
    }
    
    /* ===== Layout Structure ===== */
    .photo-session-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .control-panel {
        flex: 2;
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .photo-preview-sidebar {
        flex: 1;
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        min-width: 250px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .preview-section {
        background-color: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .customization-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    /* ===== Camera Styles ===== */
    .camera-container {
        position: relative;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
    }
    
    .camera-frame {
        position: relative;
        border: 3px solid var(--pink);
        border-radius: 15px;
        overflow: hidden;
        background-color: #000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        aspect-ratio: 4/3;
    }
    
    #video {
        width: 100%;
        height: 100%;
        display: block;
        transform: scaleX(-1);
        transition: opacity 0.3s;
        background-color: #000;
        object-fit: cover;
    }
    
    /* Camera Error State */
    .camera-error {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: rgba(0,0,0,0.7);
        color: white;
        z-index: 20;
    }
    
    .camera-error i {
        font-size: 50px;
        margin-bottom: 15px;
        color: var(--pink-light);
    }
    
    .camera-error p {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }
    
    /* ===== Modern Countdown ===== */
    .countdown {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 10;
    }
    
    .countdown-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: rgba(255, 105, 180, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 30px rgba(255,105,180,0.8);
        animation: pulse 1s infinite alternate;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 30px rgba(255,105,180,0.6); }
        100% { transform: scale(1.1); box-shadow: 0 0 50px rgba(255,105,180,1); }
    }
    
    #countdown-text {
        font-size: 72px;
        color: white;
        font-family: 'Chewy', cursive;
        text-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
    
    /* ===== Flash Effect ===== */
    .flash-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        opacity: 0;
        pointer-events: none;
        z-index: 5;
    }
    
    /* ===== Modern Strip Preview ===== */
    .strip-preview {
        display: none;
        margin: 0 auto;
        position: relative;
        max-width: var(--strip-width);
        margin-bottom: 20px;
        transition: all 0.5s ease;
    }
    
    .strip-frame {
        background: white;
        border-radius: 5px;
        padding: 5px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 10px solid white;
        width: var(--strip-width);
    }
    
    #strip-canvas {
        border-radius: 3px;
        width: 100%;
        height: auto;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s;
        border: 1px solid #ddd;
        display: block;
    }
    
    #strip-canvas:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    }

    /* ===== Photo Previews ===== */
    .photo-preview-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-top: 15px;
        min-height: 400px;
    }
    
    .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #aaa;
        font-size: 1rem;
        padding: 20px;
        border: 2px dashed var(--pink);
        border-radius: 10px;
        background-color: rgba(255,192,217,0.1);
    }
    
    .preview-placeholder i {
        font-size: 40px;
        margin-bottom: 10px;
        color: var(--pink-light);
    }
    
    .photo-preview-item {
        position: relative;
        margin-bottom: 15px;
        transition: all 0.3s;
    }
    
    .photo-preview-item:hover {
        transform: translateY(-5px);
    }
    
    .photo-preview {
        width: 100%;
        border-radius: 10px;
        border: 3px solid var(--pink);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    
    .photo-preview:hover {
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .photo-preview-number {
        position: absolute;
        top: -10px;
        left: -10px;
        background-color: var(--pink);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 16px;
        z-index: 1;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    
    /* ===== Buttons ===== */
    .main-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 12px 24px;
        border-radius: 50px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        -webkit-tap-highlight-color: transparent;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, var(--pink), var(--pink-light));
        color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
        background: linear-gradient(135deg, var(--pink-light), var(--pink));
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255,105,180,0.3);
    }
    
    .btn-success {
        background: linear-gradient(135deg, var(--green), #94e694);
        color: white;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #94e694, var(--green));
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(119,221,119,0.3);
    }
    
    .btn-danger {
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
    }
    
    .btn-danger:hover {
        background: linear-gradient(135deg, #ff8e8e, #ff6b6b);
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255,107,107,0.3);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #8a939b);
        color: white;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #8a939b, #6c757d);
        transform: translateY(-3px);
    }

    .btn-info {
        background: linear-gradient(135deg, var(--info), #5bc0de);
        color: white;
    }
    
    .btn-info:hover {
        background: linear-gradient(135deg, #5bc0de, var(--info));
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(23,162,184,0.3);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, var(--warning), #ffd45c);
        color: white;
    }
    
    .btn-warning:hover {
        background: linear-gradient(135deg, #ffd45c, var(--warning));
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255,193,7,0.3);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }
    
    .pulse-animation {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* ===== Filter Options ===== */
    .filters {
        display: flex;
        gap: 15px;
        padding: 15px 0;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .filter-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s;
        padding: 15px;
        border-radius: 10px;
    }
    
    .filter-option:hover {
        background-color: rgba(255,192,217,0.2);
        transform: translateY(-3px);
    }
    
    .filter-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid #ddd;
        transition: all 0.3s;
    }
    
    .filter-option.selected .filter-preview {
        border-color: var(--pink);
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .filter-option.selected {
        background-color: var(--pink-lighter);
    }
    
    .filter-option span {
        font-weight: 600;
        color: var(--purple-dark);
    }
</style>
<!-- ===== Customization Options ===== -->
<style>
    .option-panel {
        background-color: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }

    .option-panel:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }

    .option-panel h3 {
        color: var(--purple-dark);
        font-size: 1.3rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* ===== Stickers ===== */
    .stickers {
        display: flex;
        gap: 15px;
        padding: 10px 0;
        flex-wrap: wrap;
    }

    .sticker {
        width: 60px;
        height: 60px;
        cursor: grab;
        transition: all 0.3s;
        border-radius: 10px;
    }

    .sticker:hover {
        transform: scale(1.1) rotate(5deg);
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2));
    }

    /* ===== Color Options ===== */
    .color-pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 10px;
    }

    .page-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #ddd;
        cursor: pointer;
        transition: all 0.3s;
    }

    .page-indicator.active {
        background-color: var(--pink);
        transform: scale(1.2);
    }

    .colors {
        display: flex;
        gap: 15px;
        padding: 10px 0;
        flex-wrap: wrap;
    }

    .color-page {
        display: none;
    }

    .color-page.active {
        display: flex;
    }

    .color-option {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.3s;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .color-option.selected {
        border-color: var(--purple-dark);
        transform: scale(1.2);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .color-option:hover:not(.selected) {
        transform: scale(1.1);
    }

    /* ===== Preset Themes ===== */
    .presets {
        display: flex;
        gap: 15px;
        padding: 10px 0;
        flex-wrap: wrap;
    }

    .preset {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s;
        padding: 15px;
        border-radius: 10px;
    }

    .preset:hover {
        background-color: rgba(255,192,217,0.2);
        transform: translateY(-3px);
    }

    .preset-color {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 3px solid #ddd;
        transition: all 0.3s;
    }

    .preset:hover .preset-color {
        transform: scale(1.1);
    }

    .preset span {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--purple-dark);
    }

    /* ===== Popup ===== */
    .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .popup-panel {
        background-color: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        transform: scale(0.9);
        animation: popIn 0.3s forwards;
    }

    @keyframes popIn {
        0% { transform: scale(0.9); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .popup-panel p {
        font-size: 1.1rem;
        color: var(--purple-dark);
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .popup-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    /* ===== All Photos Captured ===== */
    .all-photos-captured {
        display: none;
        background-color: var(--green);
        color: white;
        padding: 15px;
        border-radius: 50px;
        margin: 15px auto;
        max-width: 300px;
        font-weight: 600;
        box-shadow: 0 5px 15px rgba(119,221,119,0.3);
    }

    /* ===== QR Code Styles ===== */
    #qr-code-container {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    #qr-code {
        margin: 0 auto;
        width: 150px;
        height: 150px;
        background: white;
        padding: 10px;
        border-radius: 8px;
    }

    #qr-code img {
        width: 100%;
        height: 100%;
    }

    /* ===== Sticker Containers ===== */
    .sticker-container {
        position: absolute;
        cursor: move;
        transition: transform 0.1s;
        z-index: 10;
    }

    .sticker-container:hover {
        transform: scale(1.05);
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.3));
    }

    .sticker-container img {
        width: 100%;
        height: 100%;
        pointer-events: none;
        user-select: none;
    }

    .resize-handle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: white;
        border: 2px solid var(--pink);
        border-radius: 50%;
        right: -6px;
        bottom: -6px;
        cursor: nwse-resize;
        z-index: 11;
        transition: all 0.2s;
    }

    .resize-handle:hover {
        transform: scale(1.3);
        background-color: var(--pink);
    }

    /* ===== Responsive Adjustments ===== */
    @media (max-width: 900px) {
        .photo-session-container {
            flex-direction: column;
        }
        
        .photo-preview-sidebar {
            order: -1;
        }
    }
    
    @media (max-width: 768px) {
        .main-controls {
            flex-direction: column;
            align-items: center;
        }
        
        .btn {
            width: 100%;
            max-width: 250px;
            justify-content: center;
        }
        
        .customization-options {
            grid-template-columns: 1fr;
        }
        
        .countdown-circle {
            width: 120px;
            height: 120px;
        }
        
        #countdown-text {
            font-size: 60px;
        }

        .photo-booth {
            padding: 20px;
        }

        h1 {
            font-size: 2.2rem;
        }
    }
    
    @media (max-width: 480px) {
        :root {
            --strip-width: 300px;
            --photo-size: 280px;
        }
        
        .photo-options {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 15px 10px;
        }
        
        .countdown-circle {
            width: 100px;
            height: 100px;
        }
        
        #countdown-text {
            font-size: 48px;
        }

        .popup-buttons {
            flex-direction: column;
        }

        .popup-buttons .btn {
            width: 100%;
        }

        .filter-option {
            padding: 10px;
        }

        .filter-preview {
            width: 50px;
            height: 50px;
        }

        #qr-code {
            width: 120px;
            height: 120px;
        }

        .photo-preview-container {
            min-height: 300px;
        }

        .option-panel h3 {
            font-size: 1.1rem;
        }

        .preset span, .filter-option span {
            font-size: 0.8rem;
        }
    }

    /* ===== Animation Classes ===== */
    .animate {
        animation: fadeInUp 0.6s forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ===== Flash Effect ===== */
    .flash-overlay {
        animation: flash 0.5s ease-out;
    }
    
    @keyframes flash {
        0% { opacity: 0.9; }
        100% { opacity: 0; }
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const stripCanvas = document.getElementById('strip-canvas');
        const stripCtx = stripCanvas.getContext('2d');
        const captureBtn = document.getElementById('capture-btn');
        const saveBtn = document.getElementById('save-btn');
        const qrBtn = document.getElementById('qr-btn');
        const clearStickersBtn = document.getElementById('clear-stickers-btn');
        const startBtn = document.getElementById('start-btn');
        const moreTimeBtn = document.getElementById('more-time-btn');
        const retryCameraBtn = document.getElementById('retry-camera-btn');
        const countdownText = document.getElementById('countdown-text');
        const countdownElement = document.getElementById('countdown');
        const flashOverlay = document.querySelector('.flash-overlay');
        const popupOverlay = document.getElementById('popup-overlay');
        const popupMessage = document.getElementById('popup-message');
        const popupButtons = document.getElementById('popup-buttons');
        const allPhotosText = document.getElementById('all-photos-text');
        const allPhotosCaptured = document.getElementById('all-photos-captured');
        const stripPreview = document.getElementById('strip-preview');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const photoPreviewSidebar = document.getElementById('photo-preview-sidebar');
        const dropdown = document.querySelector('.custom-dropdown');
        const selectedOption = dropdown.querySelector('.selected-option');
        const dropdownOptions = dropdown.querySelector('.dropdown-options');
        const colorOptions = document.querySelectorAll('.color-option');
        const colorPages = document.querySelectorAll('.color-page');
        const pageIndicators = document.querySelectorAll('.page-indicator');
        const presets = document.querySelectorAll('.preset');
        const stickers = document.querySelectorAll('.sticker');
        const filterOptions = document.querySelectorAll('.filter-option');
        const filterPanel = document.getElementById('filter-options');
        const customizationPanel = document.getElementById('customization-options');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrCodeElement = document.getElementById('qr-code');
        const downloadQrBtn = document.getElementById('download-qr-btn');
        const photoOptionsSection = document.querySelector('.photo-options');
        const cameraErrorElement = document.getElementById('camera-error');
        const cameraFrame = document.getElementById('camera-frame');

        // State variables
        let photos = [];
        let selectedValue = 3;
        let selectedColor = '#ff69b4';
        let selectedFilter = 'normal';
        let isCapturing = false;
        let activeSticker = null;
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
        let stickerContainers = [];
        let countdownInterval;
        let qrCodeGenerated = false;
        let cameraStream = null;

        // Initialize camera with robust error handling
        async function initCamera() {
            try {
                // Stop any existing stream
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                }

                cameraErrorElement.style.display = 'none';
                retryCameraBtn.style.display = 'none';
                captureBtn.disabled = true;

                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 1280 },
                        facingMode: 'user'
                    },
                    audio: false
                });

                cameraStream = stream;
                video.srcObject = stream;
                video.style.display = 'block';
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        // Set canvas dimensions to match video aspect ratio
                        const aspectRatio = video.videoWidth / video.videoHeight;
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        
                        video.play().then(resolve).catch(err => {
                            console.error("Video play failed:", err);
                            handleCameraError("Tap to enable camera");
                        });
                    };
                });

                captureBtn.disabled = false;
                
            } catch (err) {
                console.error("Camera initialization error:", err);
                handleCameraError(getUserFriendlyCameraError(err));
            }
        }

        function handleCameraError(message) {
            cameraErrorElement.style.display = 'flex';
            video.style.display = 'none';
            captureBtn.disabled = true;
            retryCameraBtn.style.display = 'block';
            
            const errorText = cameraErrorElement.querySelector('p');
            if (message) {
                errorText.textContent = message;
            }
        }

        function getUserFriendlyCameraError(error) {
            if (!error) return "Could not access camera. Please try again.";
            
            if (error.name === 'NotAllowedError') {
                return "Please allow camera permissions to use this feature";
            } else if (error.name === 'NotFoundError') {
                return "No camera found on this device";
            } else if (error.name === 'NotReadableError') {
                return "Camera is already in use by another application";
            } else if (error.name === 'OverconstrainedError') {
                return "Camera doesn't meet requirements";
            } else if (error.name === 'SecurityError') {
                return "Camera access is blocked for security reasons";
            } else {
                return "Could not access camera. Please try again.";
            }
        }

        retryCameraBtn.addEventListener('click', function() {
            initCamera();
        });

        function initDropdown() {
            selectedOption.addEventListener('click', function() {
                dropdownOptions.style.display = dropdownOptions.style.display === 'block' ? 'none' : 'block';
                const icon = this.querySelector('i');
                icon.style.transform = dropdownOptions.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0)';
            });

            dropdownOptions.querySelectorAll('li').forEach(option => {
                option.addEventListener('click', function() {
                    selectedOption.querySelector('span').textContent = this.textContent;
                    selectedValue = parseInt(this.getAttribute('data-value')) || 3;
                    dropdownOptions.style.display = 'none';
                    selectedOption.querySelector('i').style.transform = 'rotate(0)';
                    
                    dropdownOptions.querySelectorAll('li').forEach(li => {
                        li.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    if ((selectedValue === 1 && photos.length > 1) || 
                        (selectedValue > 1 && photos.length > 0)) {
                        resetSession();
                    }
                });
            });

            document.addEventListener('click', function(e) {
                if (!dropdown.contains(e.target)) {
                    dropdownOptions.style.display = 'none';
                    selectedOption.querySelector('i').style.transform = 'rotate(0)';
                }
            });
        }

        function initFilterOptions() {
            filterOptions.forEach(filter => {
                filter.addEventListener('click', function() {
                    filterOptions.forEach(f => f.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedFilter = this.getAttribute('data-filter') || 'normal';
                });
            });
        }

        function initColorOptions() {
            pageIndicators.forEach(indicator => {
                indicator.addEventListener('click', function() {
                    const page = this.getAttribute('data-page');
                    showColorPage(page);
                });
            });

            colorOptions.forEach(color => {
                color.addEventListener('click', function() {
                    colorOptions.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.getAttribute('data-color') || '#ff69b4';
                    
                    if (photos.length > 0) {
                        generateStripPreview();
                    }
                });
            });
        }

        function showColorPage(page) {
            colorPages.forEach(p => {
                if (p.getAttribute('data-page') === page) {
                    p.classList.add('active');
                } else {
                    p.classList.remove('active');
                }
            });

            pageIndicators.forEach(indicator => {
                if (indicator.getAttribute('data-page') === page) {
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            });
        }

        function initStickers() {
            stickers.forEach(sticker => {
                sticker.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.src);
                });
            });

            stripPreview.addEventListener('dragover', function(e) {
                e.preventDefault();
            });

            stripPreview.addEventListener('drop', function(e) {
                e.preventDefault();
                const stickerSrc = e.dataTransfer.getData('text/plain');
                if (stickerSrc) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    createStickerContainer(stickerSrc, x, y);
                }
            });
        }

        function createStickerContainer(src, x, y, width = 50, height = 50) {
            const container = document.createElement('div');
            container.className = 'sticker-container';
            container.style.position = 'absolute';
            container.style.left = `${x - width/2}px`;
            container.style.top = `${y - height/2}px`;
            container.style.width = `${width}px`;
            container.style.height = `${height}px`;
            container.style.zIndex = '10';
            container.style.cursor = 'move';
            
            const img = document.createElement('img');
            img.src = src;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.pointerEvents = 'none';
            img.style.userSelect = 'none';
            
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            resizeHandle.style.position = 'absolute';
            resizeHandle.style.width = '12px';
            resizeHandle.style.height = '12px';
            resizeHandle.style.background = 'white';
            resizeHandle.style.border = '2px solid var(--pink)';
            resizeHandle.style.borderRadius = '50%';
            resizeHandle.style.right = '-6px';
            resizeHandle.style.bottom = '-6px';
            resizeHandle.style.cursor = 'nwse-resize';
            resizeHandle.style.zIndex = '11';
            
            container.appendChild(img);
            container.appendChild(resizeHandle);
            stripPreview.appendChild(container);
            
            setupStickerInteractions(container, resizeHandle);
            stickerContainers.push(container);
            return container;
        }

        function setupStickerInteractions(container, resizeHandle) {
            container.addEventListener('mousedown', function(e) {
                if (e.target === container || e.target === container.querySelector('img')) {
                    e.preventDefault();
                    activeSticker = container;
                    container.style.boxShadow = '0 0 15px rgba(255,105,180,0.7)';
                    
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = container.getBoundingClientRect();
                    const offsetX = startX - rect.left;
                    const offsetY = startY - rect.top;
                    
                    function moveSticker(e) {
                        if (!activeSticker) return;
                        const previewRect = stripPreview.getBoundingClientRect();
                        const newX = e.clientX - offsetX - previewRect.left;
                        const newY = e.clientY - offsetY - previewRect.top;
                        
                        const maxX = stripPreview.offsetWidth - container.offsetWidth;
                        const maxY = stripPreview.offsetHeight - container.offsetHeight;
                        
                        container.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
                        container.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
                    }
                    
                    function stopMoving() {
                        document.removeEventListener('mousemove', moveSticker);
                        document.removeEventListener('mouseup', stopMoving);
                        if (activeSticker) {
                            activeSticker.style.boxShadow = 'none';
                            activeSticker = null;
                        }
                    }
                    
                    document.addEventListener('mousemove', moveSticker);
                    document.addEventListener('mouseup', stopMoving);
                }
            });
            
            resizeHandle.addEventListener('mousedown', function(e) {
                e.stopPropagation();
                e.preventDefault();
                isResizing = true;
                activeSticker = container;
                container.style.boxShadow = '0 0 15px rgba(255,105,180,0.7)';
                
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(container.style.width);
                startHeight = parseInt(container.style.height);
                
                function resizeSticker(e) {
                    if (!isResizing || !activeSticker) return;
                    
                    const width = startWidth + (e.clientX - startX);
                    const height = startHeight + (e.clientY - startY);
                    
                    const minSize = 20;
                    const newWidth = Math.max(minSize, width);
                    const newHeight = Math.max(minSize, height);
                    
                    container.style.width = `${newWidth}px`;
                    container.style.height = `${newHeight}px`;
                }
                
                function stopResizing() {
                    isResizing = false;
                    document.removeEventListener('mousemove', resizeSticker);
                    document.removeEventListener('mouseup', stopResizing);
                    if (activeSticker) {
                        activeSticker.style.boxShadow = 'none';
                        activeSticker = null;
                    }
                }
                
                document.addEventListener('mousemove', resizeSticker);
                document.addEventListener('mouseup', stopResizing);
            });
        }

        function showPopup(message, duration = 0, showButtons = false) {
            popupMessage.textContent = message;
            popupOverlay.style.display = 'flex';
            popupButtons.style.display = showButtons ? 'flex' : 'none';
            
            if (duration > 0) {
                setTimeout(hidePopup, duration);
            }
        }

        function hidePopup() {
            popupOverlay.style.display = 'none';
        }

        startBtn.addEventListener('click', () => {
            hidePopup();
            startCountdown();
        });

        moreTimeBtn.addEventListener('click', hidePopup);

        captureBtn.addEventListener('click', async function() {
            if (!video.srcObject || video.paused) {
                showPopup("Camera not ready. Please wait...", 2000, false);
                try {
                    await initCamera();
                } catch (e) {
                    console.error("Camera initialization failed:", e);
                }
                return;
            }

            if (isCapturing) {
                showPopup("Already capturing!", 1500, false);
                return;
            }

            if (photos.length > 0) {
                resetSession();
                filterPanel.style.display = 'grid';
                customizationPanel.style.display = 'none';
                clearStickersBtn.style.display = 'none';
                saveBtn.style.display = 'none';
                qrBtn.style.display = 'none';
                return;
            }

            const photoCount = parseInt(selectedValue);
            
            if (photos.length >= photoCount) {
                showPopup(`Maximum ${photoCount} photos captured!`, 2000, false);
                return;
            }

            if (photos.length === 0) {
                showPopup("Get ready! First photo in 3 seconds!", 0, true);
            } else {
                startCountdown();
            }
        });

        function startCountdown() {
            isCapturing = true;
            captureBtn.disabled = true;
            let count = 3;
            
            countdownElement.style.opacity = '1';
            countdownText.textContent = count;
            
            countdownInterval = setInterval(() => {
                count--;
                countdownText.textContent = count > 0 ? count : "CHEESE!";
                
                if (count === 0) {
                    clearInterval(countdownInterval);
                    
                    setTimeout(async () => {
                        if (video.paused) {
                            try {
                                await video.play();
                            } catch (e) {
                                console.error("Video play failed:", e);
                                resetCapture();
                                return;
                            }
                        }
                        
                        await capturePhoto();
                        countdownElement.style.opacity = '0';
                        
                        if (photos.length < parseInt(selectedValue)) {
                            startCountdown();
                        } else {
                            finishCaptureSession();
                        }
                    }, 300);
                }
            }, 1000);
        }

        function applyFilter(imageData) {
            const data = imageData.data;
            
            switch(selectedFilter) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg;
                        data[i + 1] = avg;
                        data[i + 2] = avg;
                    }
                    break;
                    
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        
                        data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                        data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                        data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                    }
                    break;
                    
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    break;
            }
            
            return imageData;
        }

        async function capturePhoto() {
            try {
                if (!video || video.readyState < 2) {
                    throw new Error("Video not ready");
                }

                // Set canvas dimensions to match video resolution
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // Draw the image with mirror effect
                ctx.save();
                ctx.scale(-1, 1);
                ctx.drawImage(video, -video.videoWidth, 0, video.videoWidth, video.videoHeight);
                ctx.restore();
                
                if (selectedFilter !== 'normal') {
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const filteredData = applyFilter(imageData);
                    ctx.putImageData(filteredData, 0, 0);
                }
                
                // Trigger flash effect
                if (flashOverlay) {
                    flashOverlay.style.animation = 'none';
                    void flashOverlay.offsetWidth; // Trigger reflow
                    flashOverlay.style.animation = 'flash 0.5s ease-out';
                }
                
                // Get the image data and add to photos array
                const photoData = canvas.toDataURL('image/png');
                photos.push(photoData);
                
                updatePhotoPreviews();
                
            } catch (error) {
                console.error("Capture failed:", error);
                showPopup("Capture failed. Please try again.", 2000, false);
                resetCapture();
            }
        }

        function updatePhotoPreviews() {
            photoPreviewContainer.innerHTML = '';
            
            if (photos.length === 0) {
                photoPreviewContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <i class="fas fa-camera"></i>
                        <p>Your photos will appear here</p>
                    </div>
                `;
                return;
            }
            
            photos.forEach((photo, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'photo-preview-item animate';
                previewDiv.innerHTML = `
                    <div class="photo-preview-number">${index + 1}</div>
                    <img src="${photo}" class="photo-preview" alt="Photo ${index + 1}">
                `;
                photoPreviewContainer.appendChild(previewDiv);
            });
        }

        function resetCapture() {
            isCapturing = false;
            captureBtn.disabled = false;
            countdownElement.style.opacity = '0';
            if (countdownInterval) clearInterval(countdownInterval);
        }

        function resetSession() {
            photos = [];
            updatePhotoPreviews();
            stripPreview.style.display = 'none';
            allPhotosCaptured.style.display = 'none';
            video.style.display = 'block';
            cameraFrame.style.display = 'block';
            photoPreviewSidebar.style.display = 'block';
            photoOptionsSection.style.display = 'flex';
            stickerContainers.forEach(container => {
                container.remove();
            });
            stickerContainers = [];
            qrCodeContainer.style.display = 'none';
            qrCodeElement.innerHTML = '';
            qrCodeGenerated = false;
        }

        async function finishCaptureSession() {
            isCapturing = false;
            allPhotosText.textContent = `All ${photos.length} photos captured!`;
            allPhotosCaptured.style.display = "block";
            
            try {
                await generateStripPreview();
                stripPreview.style.display = "block";
                video.style.display = "none";
                cameraFrame.style.display = "none";
                photoPreviewSidebar.style.display = 'none';
                photoOptionsSection.style.display = 'none';
                captureBtn.disabled = false;
                
                filterPanel.style.display = 'none';
                customizationPanel.style.display = 'grid';
                clearStickersBtn.style.display = 'block';
                saveBtn.style.display = 'block';
                qrBtn.style.display = 'block';
            } catch (error) {
                console.error("Preview generation failed:", error);
                showPopup("Couldn't generate preview", 2000, false);
            }
        }

        async function generateStripPreview() {
            return new Promise((resolve) => {
                // Calculate dimensions based on device pixel ratio for high DPI displays
                const pixelRatio = window.devicePixelRatio || 1;
                const targetWidth = 400 * pixelRatio; // Strip width
                const photoSize = 350 * pixelRatio; // Square photo size
                const spacing = 15 * pixelRatio; // Space between photos
                const stripPadding = 20 * pixelRatio; // Padding around strip
                const borderWidth = 10 * pixelRatio; // Border width

                // Calculate total strip height
                const stripHeight = (photoSize + spacing) * photos.length - spacing + stripPadding * 2 + 50;
                
                // Set canvas dimensions (actual pixels)
                stripCanvas.width = targetWidth + (borderWidth * 2);
                stripCanvas.height = stripHeight + (borderWidth * 2);
                
                // Set CSS dimensions (display size)
                stripCanvas.style.width = `${(targetWidth + (borderWidth * 2)) / pixelRatio}px`;
                stripCanvas.style.height = `${(stripHeight + (borderWidth * 2)) / pixelRatio}px`;

                stripCtx.clearRect(0, 0, stripCanvas.width, stripCanvas.height);
                
                // Draw the border (white background)
                stripCtx.fillStyle = 'white';
                stripCtx.fillRect(0, 0, stripCanvas.width, stripCanvas.height);
                
                // Draw the colored strip area with border
                if (selectedColor.startsWith('linear-gradient')) {
                    // Create gradient for the strip background
                    const gradient = stripCtx.createLinearGradient(0, 0, stripCanvas.width, stripCanvas.height);
                    const colors = selectedColor.match(/#[0-9a-f]{6}|#[0-9a-f]{3}/gi);
                    if (colors && colors.length >= 2) {
                        gradient.addColorStop(0, colors[0]);
                        gradient.addColorStop(1, colors[1]);
                        stripCtx.fillStyle = gradient;
                    } else {
                        stripCtx.fillStyle = '#ff69b4'; // fallback
                    }
                } else {
                    stripCtx.fillStyle = selectedColor;
                }
                
                stripCtx.fillRect(
                    borderWidth, 
                    borderWidth, 
                    stripCanvas.width - (borderWidth * 2), 
                    stripCanvas.height - (borderWidth * 2)
                );

                // Create an array of promises for loading all photos
                const photoPromises = photos.map((photo, index) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            // Center the photo horizontally
                            const x = borderWidth + (stripCanvas.width - (borderWidth * 2) - photoSize) / 2;
                            
                            // Calculate y position based on photo index
                            const y = borderWidth + stripPadding + (photoSize + spacing) * index;
                            
                            // Draw the photo as a perfect square
                            stripCtx.drawImage(
                                img,
                                0, 0, img.width, img.height, // source dimensions
                                x, y, photoSize, photoSize
                            );
                            resolve();
                        };
                        img.onerror = () => {
                            console.error("Failed to load photo for strip");
                            resolve();
                        };
                        img.src = photo;
                    });
                });

                // Wait for all photos to load and draw
                Promise.all(photoPromises).then(() => {
                    // Add stickers to the strip
                    stickerContainers.forEach(container => {
                        const img = container.querySelector('img');
                        if (!img) return;
                        
                        const rect = container.getBoundingClientRect();
                        const previewRect = stripPreview.getBoundingClientRect();
                        
                        const x = borderWidth + (rect.left - previewRect.left) * pixelRatio;
                        const y = borderWidth + (rect.top - previewRect.top) * pixelRatio;
                        const width = parseInt(container.style.width) * pixelRatio;
                        const height = parseInt(container.style.height) * pixelRatio;
                        
                        const tempImg = new Image();
                        tempImg.onload = () => {
                            stripCtx.drawImage(tempImg, x, y, width, height);
                        };
                        tempImg.src = img.src;
                    });

                    addStripMetadata();
                    resolve();
                });
            });
        }

        function addStripMetadata() {
            const now = new Date();
            const date = now.toLocaleDateString();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            stripCtx.fillStyle = "#000";
            stripCtx.font = `${18 * (window.devicePixelRatio || 1)}px 'Montserrat', sans-serif`;
            stripCtx.textAlign = "center";
            
            const text = `${date} ${time} - PicoBooth`;
            const textX = (stripCanvas.width / 2);
            
            stripCtx.shadowColor = 'rgba(255,255,255,0.7)';
            stripCtx.shadowBlur = 5 * (window.devicePixelRatio || 1);
            stripCtx.shadowOffsetX = 1 * (window.devicePixelRatio || 1);
            stripCtx.shadowOffsetY = 1 * (window.devicePixelRatio || 1);
            
            stripCtx.fillText(text, textX, stripCanvas.height - 20 * (window.devicePixelRatio || 1));
            
            stripCtx.shadowColor = 'transparent';
        }

        function generateQRCode() {
            if (qrCodeGenerated) {
                qrCodeContainer.style.display = qrCodeContainer.style.display === 'block' ? 'none' : 'block';
                return;
            }

            stripCanvas.toBlob(function(blob) {
                const reader = new FileReader();
                reader.onload = function() {
                    const base64data = reader.result;
                    qrCodeElement.innerHTML = '';
                    
                    try {
                        // Create QR code using qrcode-generator library
                        const qr = qrcode(0, 'H');
                        qr.addData(base64data);
                        qr.make();
                        
                        const qrSize = 150;
                        const cellSize = qrSize / qr.getModuleCount();
                        
                        const qrCanvas = document.createElement('canvas');
                        qrCanvas.width = qrSize;
                        qrCanvas.height = qrSize;
                        const qrCtx = qrCanvas.getContext('2d');
                        
                        // Draw white background
                        qrCtx.fillStyle = '#ffffff';
                        qrCtx.fillRect(0, 0, qrSize, qrSize);
                        
                        // Draw QR code
                        qrCtx.fillStyle = '#000000';
                        for (let row = 0; row < qr.getModuleCount(); row++) {
                            for (let col = 0; col < qr.getModuleCount(); col++) {
                                if (qr.isDark(row, col)) {
                                    qrCtx.fillRect(
                                        col * cellSize,
                                        row * cellSize,
                                        cellSize,
                                        cellSize
                                    );
                                }
                            }
                        }
                        
                        qrCodeElement.appendChild(qrCanvas);
                        qrCodeContainer.style.display = 'block';
                        qrCodeGenerated = true;
                    } catch (error) {
                        console.error("QR code generation failed:", error);
                        showPopup("Failed to generate QR code", 2000, false);
                    }
                };
                reader.readAsDataURL(blob);
            }, 'image/png');
        }

        saveBtn.addEventListener('click', async function() {
            if (photos.length === 0) {
                showPopup("No photos to save!", 1500, false);
                return;
            }

            try {
                await generateStripPreview();
                
                // Create a high-resolution version for printing
                const printWidth = 1200; // Higher resolution for printing
                const printRatio = printWidth / stripCanvas.width;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = printWidth;
                tempCanvas.height = stripCanvas.height * printRatio;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Scale up the strip for better print quality
                tempCtx.imageSmoothingEnabled = true;
                tempCtx.drawImage(
                    stripCanvas, 
                    0, 0, stripCanvas.width, stripCanvas.height,
                    0, 0, tempCanvas.width, tempCanvas.height
                );
                
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                link.download = `picobooth-${timestamp}.png`;
                link.href = tempCanvas.toDataURL('image/png', 1.0);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showPopup("Photo strip saved!", 1500, false);
            } catch (error) {
                console.error("Save failed:", error);
                showPopup("Save failed. Please try again.", 2000, false);
            }
        });

        qrBtn.addEventListener('click', function() {
            if (photos.length === 0) {
                showPopup("No photos to generate QR code for!", 1500, false);
                return;
            }
            generateQRCode();
        });

        downloadQrBtn.addEventListener('click', async function() {
            if (!qrCodeGenerated) {
                showPopup("Please generate QR code first", 1500, false);
                return;
            }

            try {
                // Get the QR code canvas
                const qrCanvas = qrCodeElement.querySelector('canvas');
                if (!qrCanvas) {
                    throw new Error("QR code canvas not found");
                }

                // Create download link
                const dataURL = qrCanvas.toDataURL('image/png');
                const a = document.createElement('a');
                a.href = dataURL;
                a.download = 'picobooth-qr.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch (error) {
                console.error("QR download failed:", error);
                showPopup("Failed to download QR code", 2000, false);
            }
        });

        clearStickersBtn.addEventListener('click', function() {
            stickerContainers.forEach(container => {
                container.remove();
            });
            stickerContainers = [];
            
            if (photos.length > 0) {
                generateStripPreview();
            }
        });

        function initPresets() {
            presets.forEach(preset => {
                preset.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    const stickersAttr = this.getAttribute('data-stickers');
                    
                    // Clear existing stickers safely
                    stickerContainers.forEach(container => {
                        container.remove();
                    });
                    stickerContainers = [];
                    
                    // Update color selection safely
                    colorOptions.forEach(c => {
                        c.classList.remove('selected');
                    });
                    const selectedColorOption = document.querySelector(`.color-option[data-color="${color}"]`);
                    if (selectedColorOption) {
                        selectedColorOption.classList.add('selected');
                    }
                    
                    selectedColor = color;

                    // Add new stickers with error handling
                    try {
                        const stickerFiles = stickersAttr.split(',').filter(file => file.trim());
                        
                        stickerFiles.forEach(file => {
                            const stickerSrc = `{{ url_for('static', filename='') }}${file.trim()}`;
                            
                            // Define positions with fallbacks
                            const positions = [
                                [50, 50],
                                [stripCanvas.width - 50, 50],
                                [50, stripCanvas.height - 50],
                                [stripCanvas.width - 50, stripCanvas.height - 50]
                            ];
                            
                            positions.forEach(pos => {
                                createStickerContainer(stickerSrc, pos[0], pos[1], 60, 60);
                            });
                        });

                        if (photos.length > 0) {
                            generateStripPreview().catch(e => console.error("Preview error:", e));
                        }
                        
                        const presetName = this.querySelector('span').textContent || 'theme';
                        showPopup(`Applied ${presetName}!`, 1500, false);
                    } catch (error) {
                        console.error("Error applying preset:", error);
                        showPopup("Couldn't apply preset", 1500, false);
                    }
                });
            });
        }

        // Initialize all components
        function initializeAll() {
            initCamera();
            initDropdown();
            initFilterOptions();
            initColorOptions();
            initStickers();
            initPresets();

            // Add click handler to video element to help with mobile camera activation
            video.addEventListener('click', function() {
                if (!video.srcObject) {
                    initCamera();
                }
            });
        }

        // Start initialization
        if (document.readyState === 'complete') {
            initializeAll();
        } else {
            window.addEventListener('load', initializeAll);
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !video.srcObject) {
                initCamera();
            }
        });

        // Add touch support for mobile devices
        document.addEventListener('touchend', function(e) {
            if (e.target === video && !video.srcObject) {
                initCamera();
            }
        }, { passive: true });
    });
</script>

{% endblock %}